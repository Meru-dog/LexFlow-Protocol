# LexFlow Protocol: 自律型法務エージェント & 決済統合プラットフォーム

LexFlow Protocolは、AI（LLM）とブロックチェーン技術を極限まで統合した、次世代の契約管理・履行・自動決済プラットフォームです。契約ドキュメントを「死んだテキスト」から「自律的に実行される動的なプログラマブル・コントラクト」へと進化させ、法務・財務・技術の三位一体を実現します。

---

## 1. プロジェクト全体像 (Overall Vision)

### 1.1 プロジェクトの目的
企業活動における「契約」は、締結して終わりではなく、その後の「履行管理」と「決済」が本質です。しかし、現状はこれらが完全に分断されており、多大な事務コストとリスクを生んでいます。LexFlowは、AI判定とオンチェーン証跡を用いてこれらを完全に同期させ、**「トラストレスな契約履行」**を自動化します。

### 1.2 ターゲットユーザー・ペルソナ

#### 主要ペルソナ: 大手法律事務所のパートナー弁護士

**プロフィール**
- **年齢**: 45-55歳
- **所属**: 都内企業法務弁護士事務所（弁護士800名規模）
- **役職**: パートナー弁護士
- **専門領域**: M&A、コーポレート法務、ファイナンス法務
- **業務スコープ**: 月間50-100件の契約書レビュー、10-20件の重要案件の交渉・承認判断

**抱える課題（Pain Points）**

1. **契約義務管理の属人化とリスク**
   - アソシエイト弁護士に割り振った案件の進捗把握が困難
   - 契約締結後の義務履行管理がExcel頼み、更新漏れが頻発
   - 支払期限・更新期限の見落としによる訴訟リスク
   - 年間管理する契約数が500-1,000件に達し、すべてを把握することが物理的に不可能

2. **非効率な承認プロセス**
   - 重要案件の承認に複数パートナーの押印が必要だが、タイミングが合わず1週間以上かかることも
   - 誰が何を承認したか／していないかの追跡が困難
   - 承認理由や条件が口頭伝達で記録が残らない
   - 外部取引先の承認も含めると関係者が10名を超える案件もあり混乱

3. **契約改変の追跡困難**
   - 取引先との交渉で修正が20回以上繰り返されるケースも
   - 「最終版」ファイルが複数存在し、どれが真の最終合意版か不明
   - 修正履歴をWordの変更履歴に頼ると、過去版との比較が煩雑
   - 不利な条項が紛れ込んでいても気づかず署名してしまうリスク

4. **機密情報管理の脆弱性**
   - クライアントリストを社内システムにアップロードすることに抵抗
   - 利益相反チェックのために機密情報を共有せざるを得ない矛盾
   - セキュリティインシデント時の情報漏洩リスクが経営課題

5. **証跡管理とコンプライアンス**
   - 監査法人から「誰がいつ何を承認したか」の証跡提出を求められる
   - メール添付の電子署名PDFでは改ざんリスクの指摘を受ける
   - 7-10年の保管義務があるが、過去の操作履歴を証明する手段がない

**LexFlowによる解決**

| 課題 | LexFlowの機能 | 具体的な効果 |
|------|--------------|-------------|
| 義務管理の属人化 | AI義務カレンダー | 契約書アップロード時に自動で義務を抽出・期限をカレンダー化。全パートナー・アソシエイトで共有可能。見落としリスク95%削減 |
| 非効率な承認 | 多段階承認フロー | 「100万円以上は経営委員会承認」等のルールを自動実行。平均承認期間を7日→2日に短縮 |
| 契約改変の混乱 | EIP-712暗号署名 | 各版にブロックチェーン署名を付与。「最終版」の真正性を数学的に証明。改ざん不可能 |
| 機密情報漏洩 | ZKプライバシー | 顧客リストを開示せず利益相反チェック可能。サーバーハッキングでも情報漏洩ゼロ |
| 証跡不足 | 監査証跡・ハッシュチェーン | すべての操作を改ざん不能な形で記録。**SHA-256ハッシュチェーン**により、ログ自体の真正性も数学的に証明。監査法人への提出資料を5分で生成 |
| 通知の見落とし | 統合通知システム | **EmailとSlack**の両方にリアルタイム通知。承認依頼、期限リマインド、アクション結果を即座に共有し、業務の停滞をゼロ化 |

#### その他のターゲットユーザー

**ベンチャーキャピタル / スタートアップ**  
SAFEや投資契約におけるマイルストーン管理と、JPYC等のステーブルコインによる迅速な決済を実現。資金トランシェの自動実行により、手動送金ミスを防止。

**サプライチェーン・調達部門**  
検収完了後の自動支払フローを構築。従来30-60日かかっていた支払プロセスを3日以内に短縮し、サプライヤーとの信頼関係を強化。

---

## 2. 機能要件

### 📄 AI 契約書解析 & スキーマ化
*   **意義**: 契約書という「非構造化された巨大なテキストデータ」を、後続のプログラムやスマートコントラクトが直接処理可能な、高精度の「デジタル資産（スキーマ化データ）」へと即座に変換します。

*   **目的**: 
    - 法務担当者の手作業による契約書分析時間を削減
    - ヒューマンエラーによる重要情報の見落とし防止
    - 契約書の即時検索・分析可能な構造化データの生成
    - 後続システム（義務管理、承認フロー、決済）へのシームレスなデータ連携

*   **実装内容**: 
    - **コアエンジン**: `backend/app/services/contract_parser.py` を核とし、OpenAI GPT-4モデルを使用
    - **AI統合**: LangChain/LangGraphによるマルチエージェント構成（抽出→検証→整形）
    - **入力形式**: PDF、Markdown、Plain Textの3形式に対応
    - **抽出項目**: 契約当事者、条項階層構造、法的期限、マイルストーン、金額、準拠法、義務内容、支払条件等を包括的に抽出
    - **データモデル**: Pydantic による厳格なスキーマ定義（`ParsedContract`, `ExtractedClause`等）

*   **技術的特徴**: 
    - **マルチ形式透過処理**: 
      - PDF: `pypdf` ライブラリでテキスト抽出
      - Markdown/Text: バイトストリームから直接UTF-8デコード
      - 拡張子判定による自動フォーマット選択機構
    
    - **Pydantic セマンティックパーシング**:
      ```python
      class ParsedContract(BaseModel):
          title: str
          parties: List[str]
          clauses: List[ExtractedClause]
          payment_conditions: List[Dict[str, Any]]
      ```
      - AIの出力を型安全にバリデーション
      - 欠損値や型エラーを事前検出
    
    - **LLM Context Window 最適化**:
      - 大規模契約書でも処理可能
      - 重要セグメントの自動特定アルゴリズム
      - トークン数を考慮した分割処理
    
    - **ハッシュベース整合性管理**:
      - SHA-256によるファイルハッシュ自動計算
      - 版管理とデータ整合性の保証

*   **効果**: 
    - 従来の手作業を30-60秒に短縮
    - 重要期限の見落としリスクを低減
    - 契約書の即時検索・フィルタリング可能に
    - 後続の義務管理・承認フローへ自動連携

*   **利用方法**:
    1. **契約書のアップロード**: 
       - Upload画面でPDF/Markdown/Text形式のファイルをドラッグ&ドロップ
       - ファイルは自動でバックエンドに送信
    
    2. **AI解析の実行**:
       - 「AI解析を実行」ボタンをクリック
       - バックグラウンドでGPT-4が契約書を分析（通常30-60秒）
       - 進行状況はステータスバーで確認可能
    
    3. **解析結果の確認**:
       - 契約詳細ページで抽出された情報を確認
       - 当事者名、重要条項、支払条件等が構造化されて表示
       - 義務カレンダーに自動反映される期限を確認
    
    4. **手動修正（オプション）**:
       - AIが誤認識した項目は手動で修正可能
       - 編集履歴は監査証跡として自動記録

*   **ワークフロー**: 
    ```
    ファイルアップロード
      ↓
    形式判定（PDF/MD/TXT）
      ↓
    テキスト抽出・セグメンテーション
      ↓
    GPT-4マルチステップ解析
      ↓
    Pydanticバリデーション
      ↓
    構造化JSON生成
      ↓
    DB永続化（Contract + Clause)
      ↓
    義務抽出サービスへ連携
    ```


### 📅 AI 義務カレンダー & 履行管理
*   **意義**: 契約締結後に発生する膨大な「法的義務」の履行状況を自動で可視化・追跡し、契約の形骸化（締結して終わり）を防ぎます。

*   **目的**:
    - 契約締結後の義務履行状況の一元管理
    - 支払期限・報告期限等の自動リマインド
    - 履行遅延による契約違反リスクの防止
    - 複数案件にまたがる義務の優先順位付け

*   **実装内容**: 
    - **コアサービス**: `backend/app/services/obligation_service.py` にて義務の抽出・管理
    - **データモデル**: `Obligation`（義務本体）、`ObligationEditHistory`（編集履歴）
    - **AI統合**: GPT-4による契約書からの義務自動抽出
    - **義務タイプ**: 支払義務、報告義務、通知義務、更新義務、その他
    - **ステータス管理**: PENDING（未着手）→ IN_PROGRESS（進行中）→ FULFILLED（履行済）→ OVERDUE（期限超過）
    - **証跡連携**: ブロックチェーントランザクションハッシュとの紐付け

*   **技術的特徴**:
    - **動的依存関係管理**:
      - 前段の義務完了が後段のトリガーとなる「法的ワークフロー」をシミュレート
      - 例: 「第1回支払完了」→「第2フェーズの業務開始義務発生」
      - 依存関係をグラフ構造で管理（DAG: Directed Acyclic Graph）
    
    - **証跡ベース自動履行判定**:
      ```python
      # ブロックチェーン支払検知時の自動ステータス更新
      async def update_obligation_status_from_blockchain(
          contract_id, event_type
      ):
          # 支払トランザクションハッシュを検証
          # 該当義務のステータスを自動で FULFILLED に変更
      ```
      - トランザクションハッシュによる支払完了の自動検知
      - 納品書・受領書ハッシュによる履行証明
    
    - **リスクレベル自動評価**:
      - LOW: 形式的な報告義務
      - MEDIUM: 金銭的義務（少額）
      - HIGH: 高額支払・重要な法的義務
      - AIが契約書の文脈から自動判定
    
    - **期限管理アルゴリズム**:
      - 7日前: DUE_SOON ステータスに自動変更
      - 期限超過: OVERDUE ステータスに自動変更
      - メール・Slack通知を自動送信
    
    - **編集履歴の完全記録**:
      - すべての義務編集を `ObligationEditHistory` に記録
      - 誰が・いつ・何を変更したかを追跡可能
      - 監査証跡との統合
    
    - **マルチチャネル通知連携**:
      - 期限7日前に自動でリマインドを送信
      - EmailおよびSlackの両チャネルに対応
      - 責任者の設定に基づき、パーソナライズされた通知を配信

*   **効果**:
    - 契約義務の見落としリスクを低減
    - 支払遅延・報告漏れによる契約違反を低減
    - 複数案件の並行管理を効率化（担当者の認知負荷を削減）
    - 関係者全員が「今、誰が何をすべきか」をリアルタイム同期

*   **利用方法**:
   1. **自動抽出モード**:
       - 契約書AI解析後、自動で義務が抽出されてカレンダーに表示される
       - 抽出された義務を「Obligation Timeline」ページで確認
    
    2. **手動追加・編集**:
       - 「新規義務を追加」ボタンから手動で義務を作成可能
       - 義務タイプ、期限、担当者、リスクレベルを設定
       - 編集は履歴として記録され、後から追跡可能
    
    3. **履行証跡の提出**:
       - 義務完了時に証跡（トランザクションハッシュ、納品書ハッシュ等）を添付
       - 「履行済みにする」ボタンで手動マーク、または支払検知で自動マーク
    
    4. **リマインダーとモニタリング**:
       - 期限7日前に自動でDUE_SOON状態に変更
       - メール/Slack通知が自動送信される
       - ダッシュボードで全義務の俯瞰的な状況把握

*   **ワークフロー**: 
    ```
    AI契約解析完了
      ↓
    義務項目・期限の自動抽出
      ↓
    ObligationDB登録
      ↓
    カレンダービューに表示
      ↓
    [ユーザー] 証跡提出 / [システム] 支払検知
      ↓
    履行済みステータスへ遷移
      ↓
    監査ログへ記録
    ```


### ✍️ EIP-712 暗号署名 & 不変版管理
*   **意義**: 中央集権的なドキュメント管理サーバーに依存せず、数学的かつ暗号学的な手法（ブロックチェーン技術）を用いて、合意内容の改ざん不能性と真正性を保証します。

*   **目的**:
    - 契約書の「最終版」の真正性を暗号学的に証明
    - 後出しの改ざんを不可能にする
    - 電子署名プラットフォームのコスト削減
    - 法的証拠としての強固な証跡構築

*   **実装内容**:
    - **バックエンド**: `backend/app/services/signature_service.py` でEIP-712署名検証
    - **フロントエンド**: MetaMask連携でユーザーが署名を実行
    - **署名規格**: EIP-712 (Typed Structured Data Hashing and Signing)
    - **ハッシュアルゴリズム**: SHA-256でドキュメント内容をハッシュ化
    - **検証ライブラリ**: Python `eth-account` およびJavaScript `ethers.js`

*   **技術的特徴**:
    - **EIP-712構造化データ署名**:
      ```javascript
      // ドメイン定義
      domain: {
        name: "LexFlow Protocol",
        version: "1",
        chainId: 11155111,  // Sepolia
        verifyingContract: "0x..."
      }
      // メッセージ型定義
      message: {
        caseId: "contract-123",
        version: 2,
        docHash: "0xabc...",
        timestamp: 1704067200
      }
      ```
      - MetaMask画面で署名内容を平易に表示
      - フィッシング攻撃への耐性
    
    - **真正性検証**:
      - バックエンドで `ecrecover` を使用
      - 署名からウォレットアドレスを復元
      - 当事者の一致を数学的に証明
      - 検証成功率: 99.9%以上
    
    - **SHA-256版管理**:
      - ドキュメント内容が1文字でも変わればハッシュが変化
      - どの版に対して署名がなされたかを一意に特定
      - 版管理とブロックチェーン署名の完全な統合
    
    - **署名データの永続化**:
      - 署名（r, s, v値）をDBに保存
      - タイムスタンプと紐付け
      - いつでも検証可能な形で記録

*   **効果**:
    - 署名済みドキュメントの「後出しの改ざん」が物理的に不可能
    - 電子署名プラットフォームのコスト削減
    - より強固な法的証跡の構築
    - ブロックチェーン上の不変性を活用

*   **利用方法**:
    1. **契約書版の作成**: 契約詳細ページで「新規版を作成」
    2. **署名の実行**: 
       - 「Sign with MetaMask」ボタンをクリック
       - MetaMaskポップアップで署名内容を確認
       - 署名を承認
    3. **署名の検証**: 
       - 契約詳細ページで「Verify Signature」ボタン
       - システムが自動で署名の真正性を検証
       - 結果（✓Valid / ✗Invalid）を表示
    4. **署名済み版の共有**: 
       - 署名済み版は改ざん検知機能付きで共有可能
       - 受信者は誰でも署名を検証できる

*   **ワークフロー**: 
    ```
    ドキュメント更新
      ↓
    SHA-256ハッシュ計算
      ↓
    EIP-712データ構築
      ↓
    MetaMask署名ポップアップ表示
      ↓
    ユーザーが署名を承認
      ↓
    署名データ（r,s,v）取得
      ↓
    バックエンドで鍵復元・検証
      ↓
    署名データをDBに保存
      ↓
    いつでも検証可能な状態
    ```


### 🤖 Redline AI 交渉エージェント
*   **意義**: 契約交渉における最大のボトルネックである「相手方からの修正案の精査」をAIが支援し、法的リスクの早期発見と合意形成の加速を実現します。

*   **目的**:
    - 契約修正案における法的リスクの自動検出
    - 交渉プロセスの大幅な時間短縮
    - 法務知識が不足する担当者の支援
    - 不利な条項の見落とし防止

*   **実装内容**:
    - **コアサービス**: `backend/app/services/redline_service.py` でAI分析を実行
    - **差分抽出**: Python標準ライブラリ `difflib` でテキスト比較
    - **AI分析**: GPT-4による法的リスク評価
    - **対応形式**: Markdown/Text形式の契約書
    - **UI表示**: `RedlineCompare.tsx` で差分とAI分析を可視化

*   **技術的特徴**:
    - **多層差分解析**:
      ```python
      # difflib による詳細な差分抽出
      - 追加された文言（Insert）
      - 削除された文言（Delete）
      - 変更された文言（Replace）
      # 差分箇所に番号バッジを付与
      ```
      - 文字レベルの詳細な比較
      - 差分箇所を番号付きでハイライト表示
    
    - **リスク・スケーリング**:
      - **有利 (FAVORABLE)**: 自社にとって有利な修正
      - **不利 (UNFAVORABLE)**: 自社にとって不利な修正
      - **中立 (NEUTRAL)**: 大きな影響がない修正
      - **リスクレベル**: Low / Medium / High を自動判定
      - AIが契約の文脈を理解した上で判定
    
    - **法的実質の理解**:
      - 単なる文字の変化ではなく、法的意味を分析
      - 例: 「損害賠償の上限が撤廃されている」
      - 例: 「契約期間の自動更新条項が追加されている」
      - 根拠条項と影響範囲を明示
    
    - **代替案生成（将来実装予定）**:
      - 不利な修正に対する対案をAIがドラフト
      - 自社ポリシーに基づいた修正提案

*   **効果**:
    - 法務チェックのリードタイム短縮
    - 高度な法的知識がなくても修正案の意図を把握可能
    - 交渉の勝率向上
    - 不利な条項の見落としゼロ化

*   **利用方法**:
    1. **版の比較開始**:
       - 契約詳細ページで「Compare Versions」をクリック
       - 比較したい2つの版を選択
    
    2. **AI分析の待機**:
       - システムが自動で差分抽出とAI分析を実行（30-60秒）
       - 進行状況はプログレスバーで表示
    
    3. **結果の確認**:
       - **左側**: 差分ハイライト表示（赤=削除、緑=追加）
       - **右側**: AI分析サマリー
         - 各修正箇所の番号
         -リスクレベルと有利/不利判定
         - 法的影響の説明
    
    4. **交渉への活用**:
       - 不利な修正箇所をピンポイントで指摘
       - AI分析結果を交渉材料として活用
       - 必要に応じて法務部門にエスカレーション

*   **ワークフロー**: 
    ```
    複数バージョンのドキュメント比較
      ↓
    difflib で差分抽出
      ↓
    差分箇所に番号バッジ付与
      ↓
    GPT-4 へ差分データ送信
      ↓
    AI が各修正のリスク評価
      ↓
    有利/不利/中立を判定
      ↓
    法的影響を説明文で生成
      ↓
    UI に結果をマッピングして表示
    ```


### 🛡️ ZK プライバシーオンボーディング (Privacy KYC/COI)
*   **意義**: 「特定の資格や属性を持っている」という事実を、その根拠となる個人情報や重要機密（顧客リスト等）を一切サーバーに開示することなく、数学的に証明（Zero-Knowledge Proof）します。
*   **実装内容**: `contracts/zk/` の Circom 回路を使用し、クライアントサイドで証明を生成。例えば、利益相反（Conflict of Interest）チェックにおいて、弁護士は自分の顧客リストという「秘密」を入力としつつ、今回の相手方がそのリストに含まれていないという証明のみを発行します。
*   **技術的特徴**:
    - **Groth16 ZK-SNARKs**: 非常に軽量で高速な検証が可能なアルゴリズムを採用。
    - **SnarkJS 統合**: ブラウザ上（WASM）で証明を生成し、サーバー側（`backend/app/services/zk_verifier.py`）で検証する非中央集権的な設計。
*   **効果**: サーバーがハッキングされたとしても、元データ（個人情報や顧客リスト）が存在しないため、漏洩リスクが物理的に存在しません。
*   **ワークフロー**: ユーザーの秘密情報入力（ローカル環境） → ZK証明生成（WASM） → 証明とパブリック信号の送信 → バックエンドでの数学的妥当性検証。

### ZK KYC: 「審査なし」ではなく「検証の分離」
「入力データを開示せずにKYCができる」というのは、**審査を省くという意味ではありません。**
- **モデル**: 信頼できる第三者機関（Identity Provider: 政府公認のデジタルIDサービスや、免許証・パスポートを認証する民間機関）が事前に厳格な審査を行い、ユーザーに本人しか知り得ない「秘密鍵（Identity Secret）」とそのハッシュを紐付けて発行します。
- **LexFlowの役割**: LexFlowは個人情報を直接見る代わりに、「あなたが正式な審査を通過した証（Secret）を所有していること」という**証明（Proof）のみを数学的に検証**します。
- **メリット**: LexFlowは高いコンプライアンス要件を満たしつつ、ハッキング時の個人情報流出リスクを「物理的にゼロ」にできます。

### 利益相反(COI)チェックの活用例: 「対立する相手方」との照合
弁護士が新規案件を受任する際、以下の問題を解決します。
- **課題**: 相手方の名前が「過去の顧客リスト（機密）」にあるか確認したいが、顧客リスト自体を第三者のシステムにアップロードすることは守秘義務違反になる。
- **ZKの活用**: 
    1. 自分のPC内で既存顧客リスト（秘密）と、今回の案件の「相手方（Adverse Party）」の名前を照合。
    2. ZK証明を生成。「リストには今回の相手方が含まれていない」という事実だけを証明。
    3. リスト自体は一度もネットワークに出ることなく、受任処理を安全に進められます。

### 履行状態証明 (Fulfillment Proof): 金銭以外の義務の完了
LexFlowでは支払いは JPYC（ステーブルコイン）で行われますが、ZK履行証明は「支払い以外の条件」が満たされたことを証明するために使用します。
- **活用例**:
    - **物理的納品**: 倉庫への商品搬入が完了した際、署名済みの受領書ハッシュを証拠として履行を証明。
    - **機密データ提供**: NDA下のソースコードや設計図が共有された事実を、データ自体をブロックチェーンに載せずに証明。
    - **KPI達成**: 非公開の財務データやユーザー数が目標値を超えたことを、詳細な数値を伏せたまま証明。
- **ワークフロー**: あらかじめ合意した証拠のハッシュ（Expected Hash）に対し、手元の生データが一致することを数学的に証明します。

---
### 💳 x402 ネイティブ支払ゲートウェイ
*   **意義**: 「価値のあるリサーチや解析」と「その対価の支払い」を、HTTPプロトコルレベルで原子性（Atomicity）を持たせ、Web3時代の「Pay-per-Use」を実現します。
*   **実装内容**: `backend/app/core/x402.py` の `PaymentVerifier` クラスを FastAPI の依存関係（Dependency Injection）として組み込み。特定のエンドポイント（AI解析等）に対し、実行前に JPYC 等のステーブルコインの支払いを要求（HTTP 402 Payment Required）します。
*   **技術的特徴**:
    - **オンチェーン検証**: トランザクションハッシュをヘッダーに乗せ、バックエンドが RPC 経由でブロックチェーン（Sepolia等）をスキャンし、正しい宛先・金額が着金しているかをリアルタイム検証。
    - **二重プレフィックス防止と同期管理**: 同一トランザクションの使い回しやネットワーク不整合を考慮した堅牢なセキュリティ。
*   **効果**: 未払い・回収不能リスクがゼロ。APIキーの販売・管理といった中央集権的な手間を省き、仮想通貨ウォレット一つでグローバルな法的サービスの利用を可能に。
*   **ワークフロー**: APIリクエスト → 402未払い検知 → MetaMask決済ポップアップ → トランザクション送信 → 再リクエスト（Hash付） → 着金検証成功 → 解析結果返却。

### 🔐 認証・ウォレット連携
*   **意義**: ユーザー認証とウォレット認証を組み合わせた二要素認証相当のセキュリティを提供し、契約書へのアクセスを厳格に管理します。
*   **実装内容**: `backend/app/api/auth.py` および `backend/app/services/auth_service.py` により、メール/パスワードでのサインアップ・ログインと、MetaMask署名によるウォレット紐付けを実現。
*   **技術的特徴**:
    - **JWT認証**: アクセストークン（24時間）とリフレッシュトークン（7日間）の二層構造。
    - **Nonce署名**: ウォレット連携時にリプレイ攻撃を防ぐワンタイムnonceを生成。
    - **bcryptハッシュ**: パスワードは業界標準のbcryptで不可逆的にハッシュ化。
*   **効果**: 「誰がログインしたか」と「そのウォレットを本当に所有しているか」を二段階で証明可能。
*   **ワークフロー**: サインアップ → メール確認 → ログイン → ウォレットnonce取得 → MetaMask署名 → ウォレット紐付け完了。

### 👥 RBAC・契約書ACL
*   **意義**: 法律事務所で必須の「役割ベースアクセス制御（RBAC）」と、契約書単位での細かなアクセス制御（ACL）を提供します。

*   **目的**:
    - 組織内の役割に応じた権限の階層的管理
    - 機密契約書へのアクセス制限
    - 最小権限の原則（Principle of Least Privilege）の実現
    - マルチテナント環境でのデータ隔離

*   **実装内容**: 
    - **コアAPI**: `backend/app/api/rbac.py` で全権限管理を実施
    - **データモデル**:
      - `Workspace`: テナント単位の作業領域
      - `Role`: 役割定義（標準6種+カスタム）
      - `Permission`: 16種類の細分化された権限
      - `ContractACL`: 契約書単位のアクセス制御
    - **標準ロール**: Owner, Admin, Manager, Member, Approver, Auditor
    - **権限カテゴリ**: ワークスペース管理、契約管理、承認管理、監査、RBAC管理

*   **技術的特徴**:
    - **階層的権限モデル**:
      ```
      Workspace (テナント)
        ↓
      Role (Owner/Admin/Manager...)
        ↓
      Permission (16種類の細分化権限)
        ↓
      User Assignment (ユーザーへの割り当て)
      ```
    
    - **カスタムロール機能**:
      - 組織独自のロール名を定義可能
      - デフォルト権限セットを自動付与
      - 後から権限を細かく調整可能
    
    - **権限継承と優先順位**:
      - ユーザー直接付与 > ロール付与 の順で権限を解決
      - より特定的な権限が優先される設計
      - 権限の競合を自動解消
    
    - **契約書レベルACL**:
      ```python
      # 契約書ごとに view/edit/approve 権限を個別設定
      ContractACL(
          contract_id="...",
          user_id="...",
          can_view=True,
          can_edit=False,
          can_approve=True
      )
      ```
    
    - **監査ログ完全連携**:
      - すべての権限変更を `AuditEvent` として記録
      - 「誰が・誰に・いつ・どの権限を付与/剥奪したか」を追跡

*   **効果**:
    - 複雑な組織構造に対応した柔軟な権限管理
    - 機密契約の漏洩リスク低減
    - コンプライアンス要件への対応
    - 監査対応の効率化

*   **利用方法**:
    1. **ワークスペースの作成**:
       - 「Workspaces」ページで新規作成
       - 作成者に自動でOwnerロールが付与
    
    2. **メンバーの招待**:
       - 「Workspace Settings」でメンバーを招待
       - メールアドレスまたは名前で検索
       - 適切なロールを選択して招待
    
    3. **カスタムロールの作成**:
       - 「Roles」タブで「新規ロール作成」
       - ロール名と権限セットを定義
       - メンバーに割り当て
    
    4. **契約書ACLの設定**:
       - 契約書詳細ページの「Access Control」セクション
       - 特定ユーザーへのview/edit/approve権限を個別設定
       - 機密案件は必要最小限のメンバーのみにアクセス許可

*   **ワークフロー**: 
    ```
    ワークスペース作成
      ↓
    標準ロール自動初期化 (6種類)
      ↓
    メンバー招待
      ↓
    ロール割り当て
      ↓
    [オプション] 契約書ACL設定
      ↓
    アクセス制御適用
      ↓
    監査ログ記録
    ```


### ✅ 承認フロー・マジックリンク
*   **意義**: 複数人・順序付き・条件分岐に対応した承認プロセスを構築し、「誰がいつ何を承認したか」の完全な証跡を残します。

*   **目的**:
    - 複雑な承認プロセスの自動化とシステム化
    - 承認の抜け漏れ・遅延の防止
    - 外部承認者（取引先）の簡易な承認参加
    - 承認履歴の完全な証跡記録

*   **実装内容**: 
    - **コアAPI**: `backend/app/api/approvals.py` にて全機能を管理
    - **データモデル**:
      - `ApprovalFlow`: 再利用可能なフローテンプレート
      - `ApprovalRequest`: 個別の承認依頼
      - `ApprovalTask`: 各承認者へのタスク
      - `MagicLink`: 外部承認者向けワンタイムURL
    - **ステータス管理**: PENDING → APPROVED / REJECTED / RETURNED
    - **UI統合**: フロントエンド `ApprovalFlows.tsx` で一元管理

*   **技術的特徴**:
    - **マルチステージ承認アーキテクチャ**:
      ```python
      # 並列承認: stage=1で複数人に同時依頼
      # 順序承認: stage=1完了後にstage=2へ自動進行
      # 混在: stage=1は並列、stage=2は順序
      ```
      - 各ステージに複数の承認者を配置可能
      - ステージ間の依存関係を自動管理
    
    - **条件分岐エンジン**:
      - 契約金額・相手方名・契約タイプに基づく動的ルーティング
      - 「1000万円以上は経営会議承認を追加」等のビジネスルールを実装
      - コード不要でUIから条件設定可能（将来実装予定）
    
    - **マジックリンク認証**:
      - UUID + 有効期限付きワンタイムトークン
      - ログイン不要で外部承認者が安全にアクセス
      - 使用後自動失効、手動失効も可能
      - セキュリティ: トークンは暗号学的にランダム生成
    
    - **承認アクションの3つのパターン**:
      - **承認（Approve）**: 次ステージへ進行
      - **否認（Reject）**: リクエスト全体を却下
      - **差戻し（Return）**: 修正を依頼（再提出可能）
      - すべてコメント付きで記録

    - **リアルタイム通知統合**:
      - 承認タスク割り当て時に担当者へ通知（Email/Slack）
      - 承認者がアクション（承認/否認/差戻し）を実行した際、即座に依頼者へ結果を通知
      - 全ステージ完了時の「最終承認」通知も自動適正化
      - 担当者の名前やコメントを含む詳細な通知内容
      
*   **効果**:
    - 承認プロセスの透明化と時間短縮
    - 「誰が承認していないか」の即座の可視化
    - 外部承認者の参加障壁の排除
    - 監査対応に必要な完全な証跡の自動記録

*   **利用方法**:
    1. **フローテンプレートの作成**:
       - 「Approval Flows」ページで「新規フロー作成」
       - フロー名、説明、ステージ構成を定義
       - 各ステージに承認者を割り当て
    
    2. **承認リクエストの発行**:
       - 契約書詳細ページから「承認依頼を作成」
       - 使用するフローを選択
       - オプションでメッセージを添付
    
    3. **承認タスクの処理**:
       - 「Your Pending Tasks」タブで自分のタスクを確認
       - 承認・否認・差戻しのいずれかを選択
       - コメントを記入して送信
    
    4. **マジックリンクの送信**（外部承認者）:
       - システムが自動でマジックリンクを生成
       - メールで外部承認者に送信
       - 相手はリンクをクリックするだけで承認画面へ

*   **ワークフロー**: 
    ```
    フローテンプレート作成
      ↓
    承認リクエスト発行
      ↓
    ステージ1タスク生成
      ↓
    [並列] 複数承認者へ通知
      ↓
    全員承認完了
      ↓
    ステージ2へ自動進行
      ↓
    最終承認完了
      ↓
    リクエストステータス: APPROVED
    ```

### 📋 監査証跡・ハッシュチェーン
*   **意義**: すべての重要操作を改ざん不能な形で記録し、内部監査・外部監査・訴訟対応に即座に対応できる証跡基盤を構築します。

*   **目的**:
    - 全ユーザー操作の完全な記録と追跡
    - 改ざん検知機能によるデータ整合性の保証
    - 監査法人への証跡資料の即座の提供
    - 訴訟・コンプライアンス調査への備え

*   **実装内容**: 
    - **コアAPI**: `backend/app/api/audit.py` で監査ログを管理
    - **サービスレイヤー**: `backend/app/services/audit_service.py` でハッシュチェーン生成
    - **データモデル**: `AuditEvent` (イベント本体)
    - **イベントタイプ**: 30種類以上
      - 認証系: LOGIN, LOGOUT, SIGNUP
      - 権限系: ROLE_ASSIGNED, PERMISSION_CHANGED
      - 契約系: CONTRACT_CREATED, CONTRACT_EDITED, VERSION_ADDED
      - 承認系: APPROVAL_REQUESTED, TASK_APPROVED, TASK_REJECTED
    - **ハッシュアルゴリズム**: SHA-256

*   **技術特長**:
    - **ハッシュチェーン (SHA-256)**:
      - 各ログが直前のログのハッシュを保持する連結構造
      - 1件のログ改ざんがチェーン全体を破壊するため、数学的に改竄を無効化
    - **高度なエクスポート機能**:
      - 特定のワークスペース、契約書、期間、ユーザーに絞った証跡をCSV/JSONで抽出
      - 監査法人や税務署への提出を想定した構造化出力
    - **整合性検証エンジン**:
      - システムが全ログを再走査し、チェーンが健全（Healthy）かをクリックひとつで検証
    - **完全なメタデータ**:
      - 操作者(Actor)、対象(Resource)、アクション、変更前後の値、IPアドレス、タイムスタンプを完全網羅

*   **効果**:
    - 「誰がいつ何をしたか」の完全な追跡
    - 改ざん検知によるデータ信頼性の保証
    - 監査対応の大幅な効率化
    - 法的紛争時の証拠資料として活用

*   **利用方法**:
    1. **自動記録**（特に操作不要）: すべての重要操作が自動的に記録される
    2. **監査ログの検索**: Dashboard の「Audit Log」タブで期間・ユーザー・イベントタイプでフィルタ
    3. **整合性検証**: 「Verify Integrity」ボタンで全ハッシュチェーンを検証
    4. **監査資料の提供**: 監査法人からの要求時にフィルタで絞り込みCSV/JSONエクスポート

*   **ワークフロー**: 
    ```
    操作発生（ログイン・編集等）
      ↓
    イベントデータ生成
      ↓
    前イベントのハッシュ取得
      ↓
    現イベントのハッシュ計算
      ↓
    チェーン化してDB永続化
      ↓
    [必要時] 検索・検証・エクスポート
    ```


### 📧 通知システム
*   **意義**: 承認依頼・期限リマインド・結果通知をメール/Slackで確実に届け、業務の「待ち」を最小化します。

*   **目的**:
    - リアルタイムな通知による業務の速度向上
    - 承認依頼・期限の見落とし防止
    - 複数チャネル（Email/Slack）への柔軟な対応
    - 通知失敗の自動リトライ

*   **実装内容**: 
    - **コアAPI**: `backend/app/api/notifications.py` で通知管理
    - **サービスレイヤー**: `backend/app/services/notification_service.py` で送信処理
    - **データモデル**: `Notification` (通知ログ)
    - **対応チャネル**:
      - Email: SendGrid/SMTP対応
      - Slack: Webhook連携
    - **通知タイプ**:
      - 承認依頼 (APPROVAL_REQUESTED)
      - 期限リマインド (OBLIGATION_DUE_SOON)
      - 承認結果 (APPROVAL_COMPLETED)
      - システム通知 (SYSTEM_ALERT)

*   **技術的特徴**:
    - **マルチチャネル配信サービス**:
      - **Email**: SendGrid/SMTPを通じた公式通知
      - **Slack**: 受信者ごとのWebhook URLを用いたパーソナライズ通知
    - **通知テンプレートエンジン**:
      - 承認依頼: 「[承認者名] 様、[契約書名] の承認をお願いします」
      - 状況更新: 「[契約書名] が [アクション名] されました（コメント: [内容]）」
      - リマインド: 「⚠️ 本日 [契約書名] の期限日です」
      - Slack向けの構造化ブロック（Rich Sections, Buttons）による操作性の向上
    - **プロフィール統合**:
      - ユーザーが自身のSlack Webhook URLを設定・テストできるUIを完備
    - **状態管理とリトライ**:
      - PENDING → SENT/FAILED の状態を追跡し、失敗時は詳細なエラー理由を記録（通知履歴画面で確認可能）

*   **効果**:
    - 承認依頼の即座の認知
    - 期限迫るタスクの見落とし防止
    - チームのコミュニケーション効率向上
    - ボトルネックの可視化

*   **利用方法**:
    1. **通知設定**（プロフィール）: ユーザープロフィールでメールアドレス・Slack Webhookを登録
    2. **自動通知の受信**: 承認依頼発行時、期限7日前、承認完了時に自動通知
    3. **通知履歴の確認**: 「Notifications」ページで送信履歴を確認・手動再送
    4. **カスタマイズ**（将来）: 通知タイミング、テンプレート、頻度の制御

*   **ワークフロー**: 
    ```
    イベント発生（承認依頼等）
      ↓
    通知ペイロード生成
      ↓
    チャネル選択 (Email/Slack)
      ↓
    テンプレート適用
      ↓
    送信試行
      ↓
    [成功] ログ記録
    [失敗] リトライキュー登録
    ```

### ワークスペース管理の完全実装
企業やプロジェクトごとに独立した作業環境を提供するワークスペース機能を実装しました。

*   **ワークスペース作成**: ヘッダーの「Workspaces」リンクから、新規ワークスペースを簡単に作成可能。
*   **自動オーナー割り当て**: ワークスペース作成者に自動的に「Owner」ロールが付与され、即座に管理権限を取得。
*   **メンバー管理**: 
    - ユーザーを名前またはメールアドレスで検索して招待
    - システムに存在しないユーザーは自動的に作成（クイック作成機能）
    - 柔軟なロール割り当て（既存ロールの選択または新規ロール名の入力）

### ロールベースアクセス制御 (RBAC) の強化
きめ細かな権限管理を実現するRBAC機能を大幅に強化しました。

*   **標準ロール**: Owner、Admin、Manager、Member、Approver、Auditorの6種類を自動生成
*   **カスタムロール**: 組織独自のロール名を入力すると、デフォルト権限で自動作成
*   **権限の完全日本語化**: 
    - `workspace:manage_roles` → 「ロール管理」
    - `contract:manage_acl` → 「アクセス制御管理 (ACL)」
    - `approval:create_flow` → 「承認フロー作成」
    - など、すべての技術的な権限キーを分かりやすい日本語で表示
*   **視認性の向上**: 
    - 権限をタグクラウドから縦型の箇条書きリストに変更
    - フォントサイズを0.95remに拡大し、カスタム箇条書き記号（•）を使用

### 承認ワークフローの完全実装
多段階の承認プロセスを柔軟に構築・管理できる承認フロー機能を実装しました。

*   **承認フローの作成**: 
    - フロー名、説明、複数の承認ステージを定義
    - 各ステージに承認者を割り当て（ワークスペースメンバーから選択）
    - 並列承認・順序付き承認の両方に対応
*   **承認フローの編集**: 
    - 既存フローの名前や説明を更新可能
    - ステージ構成の変更にも対応
*   **承認依頼の作成**: 
    - **契約書アップロード直後**: 成功画面から即座に承認依頼を作成
    - **契約書詳細ページ**: いつでも既存の契約書に対して承認依頼を追加
    - フロー選択とオプションのメッセージ入力が可能
*   **承認タスクの管理**: 
    - 「承認待ち」タブで自分に割り当てられたタスクを一覧表示
    - 「リクエスト」タブで自分が作成した承認依頼の状態を追跡
*   **UI/UX の改善**: 
    - フローカードに2px枠線と影を追加し、視覚的に区別
    - ホバー時のアニメーション効果（上方向に2px移動、枠線色変更）
    - タイトルフォント1.75rem、説明フォント1.05remで視認性向上


---

## 3. 実装方法 (Implementation Detail)

### 3.1 AI解析ワークフロー (LangGraph)
AIは複数のエージェント（解析・検証・整形）に分かれて動作します。
1.  **解析エージェント**: PDFからテキストを抽出し、法的なエンティティ（条項、金額、期日）を特定。
2.  **検証エージェント**: 抽出されたデータが契約本文のどこに基づいているか（根拠条項）をクロスチェック。
3.  **スキーマ生成**: 最終的なJSONデータを生成し、バックエンドへ受け渡し。

### 3.2 ブロックチェーン & 署名 (EIP-712)
`eth-account` (Python) と `ethers.js` (TypeScript) を使用して、以下のドメイン・タイプ定義を共有しています。
*   **Domain**: `name: "LexFlow Protocol"`, `version: "1"`, `chainId: 11155111`
*   **Message**: `caseId`, `version`, `docHash`, `timestamp`
*   **Verification**: バックエンドが `ecrecover` を実行し、復元されたアドレスが署名者と一致するか検証。

### 3.3 支払ゲートウェイ (x402)
FastAPIの依存関係注入（Dependency Injection）を利用して、特定のエンドポイントに `PaymentVerifier` を適用しています。
- 未払い時は `402 Payment Required` を送出し、フロントエンドで自動的に MetaMask 決済モーダルを起動。
### 3.4 ゼロ知識証明 (ZK Proofs)
`circom` と `snarkjs` を使用したプライバシー保護機能が `contracts/zk/` に実装されています。
*   **KYC検証**: 身元情報を開示せず、有効なプロバイダーにより承認されたKYCを保持していることを数学的に証明。
*   **利益相反チェック**: クライアントリスト（秘密）の中に、新規案件の相手方が含まれていないことを証明。
*   **詳細**: セットアップ方法については後述の [4.5 ゼロ知識証明のセットアップ](#45-ゼロ知識証明のセットアップ-zk-proofs-setup) を参照してください。

---

## 4. デプロイ方法 (Deployment Guide)

### 4.1 Prerequisites
- Python 3.9+
- Node.js 18+
- MetaMaskウォレット（Sepolia TestnetにJPYC/ETHがあること）

### 4.2 バックエンドの起動
```bash
cd backend
python -m venv venv
source venv/bin/activate
pip install -r requirements.txt
# .envの設定 (OPENAI_API_KEY, ETHEREUM_RPC_URL)
uvicorn app.main:app --reload --port 8000
```

### 4.3 フロントエンドの起動
```bash
cd frontend
npm install
# .envの設定 (VITE_API_URL=http://localhost:8000/api/v1)
npm run dev
```

### 4.4 スマートコントラクトのセットアップ (Smart Contracts Setup)
1. `contracts` ディレクトリへ移動して依存関係をインストール:
   ```bash
   cd contracts
   npm install
   ```
2. 環境変数の設定:
   `.env.example` を `.env` にコピーし、RPC URL とプライベートキーを設定してください。
3. コントラクトのコンパイルとテスト:
   ```bash
   npm run compile
   npm run test
   ```

### 4.5 ゼロ知識証明のセットアップ (ZK Proofs Setup)
1. `circom` のインストール (未完了の場合):
   ```bash
   # Rustがインストールされていない場合
   curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
   
   # Circomのインストール
   git clone https://github.com/iden3/circom.git
   cd circom
   cargo build --release
   cargo install --path circom
   ```
2. `contracts/zk` ディレクトリで依存関係をインストールし、Powers of Tau をダウンロード (プロジェクトのルートから実行):
   ```bash
   cd contracts/zk
   npm install
   # 信頼できるミラーサイトからダウンロード（より大きな回路に対応するため _12 を使用）
   curl -L https://storage.googleapis.com/zkevm/ptau/powersOfTau28_hez_final_12.ptau -o powersOfTau28_hez_final_12.ptau
   ```
3. 回路のコンパイルと信頼セットアップ:
   ```bash
   npm run compile:all
   npm run setup:all
   npm run export:all
   ```

---

## 5. ロードマップ (Roadmap)

現在実装済みの機能を基盤として、以下の5つのフェーズで機能拡張を進めます。

### Phase 1: エンタープライズ強化（3-6ヶ月）
**目的**: 法律事務所での本格運用に向けた機能強化

- **SSO統合**:
  - Google Workspace / Microsoft Entra ID (Azure AD) との連携
  - SAML 2.0 / OAuth 2.0 プロトコル対応
  - 実装: `python-saml` ライブラリでSAMLフロー構築
  
- **監査レポート自動生成**:
  - 監査証跡から月次/年次レポートを自動生成
  - PDF/Excel形式でのエクスポート機能
  - 実装: `reportlab` (PDF) + `openpyxl` (Excel) を使用

- **高度な検索機能**:
  - 全文検索エンジン (Elasticsearch) の統合
  - 契約書内容の横断検索
  - 実装: `elasticsearch-py` でインデックス作成・検索

### Phase 2: AI機能の高度化（6-9ヶ月）
**目的**: AI による契約リスク予測と判例検索の実現

- **契約リスク予測モデル**:
  - 過去の契約データから紛争リスクを予測
  - GPT-4 + Fine-tuning で自社データに最適化
  - 予測精度目標: 80%以上
  
- **判例検索エンジン**:
  - 契約条項に関連する判例を自動検索
  - ベクトルDB (Pinecone / Weaviate) で類似判例を発見
  - 実装: LangChain + Embeddings で検索パイプライン構築

- **契約ドラフト自動生成**:
  - テンプレート + ユーザー入力から契約書を自動生成
  - 業種別・契約タイプ別のテンプレート整備
  - 実装: GPT-4 with structured output

### Phase 3: ブロックチェーン機能拡張（9-12ヶ月）
**目的**: マルチチェーン対応とDeFi統合

- **マルチチェーン対応**:
  - Ethereum Mainnet / Polygon / Arbitrum への対応
  - クロスチェーンブリッジの統合
  - 実装: `web3.py` のマルチプロバイダー設定

- **DeFi統合**:
  - Aave / Compound での担保管理
  - 自動スワップ機能 (Uniswap / 1inch 連携)
  - 実装: DEX Aggregator API 統合

- **NFT契約証明書**:
  - 契約書をNFT化して所有権を証明
  - ERC-721 / ERC-1155 規格対応
  - 実装: Hardhat でNFTコントラクト開発

### Phase 4:グローバル展開（12-18ヶ月）
**目的**: 多言語対応と国際法への対応

- **多言語対応**:
  - UI の英語・中国語・韓国語対応
  - i18n (react-i18next) による国際化
  - AI解析の多言語契約書対応

- **国際法対応**:
  - 各国の法域に応じた条項テンプレート
  - GDPR / CCPA 等のプライバシー法制対応
  - タイムゾーン・通貨の完全対応

- **海外決済対応**:
  - USD / EUR ステーブルコイン (USDC / EURC) 対応
  - 国際送金の最適化

### Phase 5: エコシステム構築（18-24ヶ月）
**目的**: API公開とサードパーティ連携

- **Public API公開**:
  - REST API / GraphQL の外部公開
  - APIキー管理・レート制限
  - 実装: FastAPI + APIキー認証 + Redis レート制限

- **Zapier / Make.com 連携**:
  - ノーコードツールとの統合
  - イベントトリガー・アクション実装

- **法務SaaSとの連携**:
  - 電子契約サービス (DocuSign / CloudSign) との連携
  - 訴訟管理システムとのデータ連携
  - 実装: Webhook + OAuth 2.0 統合

- **マーケットプレイス**:
  - サードパーティ製の契約テンプレート販売
  - プラグイン機構の実装

---

## 6. ユーザーガイド (User Guide)

LexFlow Protocol を使った契約管理の具体的な流れを、ユーザー体験（UX）に沿って解説します。

### 6.1 ロール別ガイド

#### パートナー弁護士の使い方
**役割**: 案件の最終承認、重要契約の精査、チーム管理

**日常業務フロー**:
1. **ダッシュボードで全体把握**:
   - 「Your Pending Tasks」で承認待ちタスクを確認
   - 期限が近い義務をカレンダーで確認
   - 重要案件にフラグを立てる

2. **承認タスクの処理**:
   - 契約詳細ページで内容を確認
   - AI分析結果でリスクを把握
   - コメント付きで承認/否認/差戻し

3. **チーム管理**:
   - Workspace Settingsでメンバーの権限を調整
   - 特定案件のACLを設定して機密保持
   - 監査ログで操作履歴を確認

#### アソシエイト弁護士の使い方
**役割**: 契約書のドラフト、交渉、修正案の分析

**契約交渉フロー**:
1. **契約書のアップロード**:
   - Uploadページで契約書をドラッグ&ドロップ
   - AI解析を実行（30-60秒）
   - 抽出された条項・義務を確認

2. **修正版の比較**:
   - 相手方からの修正案を新しい版としてアップロード
   - 「Compare Versions」で差分とAI分析を確認
   - 不利な条項をピックアップ

3. **パートナーへのエスカレーション**:
   - 重要な修正があれば承認リクエストを発行
   - コメント欄に懸念点を記載
   - マジックリンクで外部承認者（クライアント）を招待

#### 法務事務スタッフの使い方
**役割**: 契約書の登録、義務の追跡、リマインド

**定型業務フロー**:
1. **契約書の登録**:
   - 締結済み契約をシステムに一括登録
   - カテゴリ・相手方・期限を設定
   - 自動義務抽出を実行

2. **義務管理**:
   - Obligation Timelineで期限を確認
   - 担当者にリマインドを送信
   - 履行証跡（領収書等）を添付

3. **報告業務**:
   - 監査ログから月次レポートを生成
   - 期限迫る義務のリストをエクスポート
   - パートナーに定期報告

### 6.2 シナリオ別ガイド

#### 初回セットアップ
**所要時間**: 30分

1. **アカウント作成**:
   - サインアップページでメール・パスワード登録
   - メール認証を完了

2. **ウォレット連携**:
   - MetaMaskをインストール（未インストールの場合）
   - Profileページで「Connect Wallet」
   - MetaMaskで署名を承認

3. **ワークスペース作成**:
   - 「Workspaces」から新規作成
   - 組織名を入力
   - 作成者に自動でOwnerロールが付与

4. **チームメンバー招待**:
   - Workspace Settingsの「Members」タブ
   - メールアドレスでメンバーを招待
   - 適切なロール（Admin/Manager/Member）を割り当て

5. **承認フロー作成**:
   - Approval Flowsページで「New Flow」
   - ステージと承認者を定義
   - 保存して再利用可能なテンプレートに

#### 新規契約の交渉フロー
**所要時間**: 契約により異なる（数日〜数週間）

1. **初版のアップロード**:
   - Upload画面で契約ドラフトをアップロード
   - 「AI解析を実行」ボタンをクリック
   - 抽出結果を確認・必要に応じて修正

2. **相手方からの修正案受領**:
   - 修正版を新しい版としてアップロード
   - Contract DetailページでバージョンリストにV2として表示

3. **差分分析**:
   - 「Compare Versions」でV1とV2を選択
   - AI が自動で差分を抽出・リスク評価
   - 不利な修正箇所を確認

4. **内部承認プロセス**:
   - 「Create Approval Request」で承認依頼
   - 使用するフローを選択
   - コメントを添えて送信

5. **パートナーの承認**:
   - パートナーが通知を受信
   - Approval Flowsページでタスクを確認
   - 承認/否認/差戻しを選択

6. **最終版への署名**:
   - 全承認完了後、最終版に「Sign with MetaMask」
   - EIP-712署名を実行
   - 署名データがブロックチェーンに記録

7. **契約締結完了**:
   - 義務が自動でカレンダーに登録
   - 関係者に通知が送信
   - 監査ログに全プロセスが記録

#### 義務履行の追跡フロー
**所要時間**: 継続的（契約期間中）

1. **義務カレンダーの確認**:
   - Dashboardまたは Obligation Timelineを開く
   - 期限が近い義務（DUE_SOON）を確認
   - 担当者を確認

2. **支払義務の場合**:
   - 支払期限7日前に自動リマインド
   - MetaMask等で支払を実行
   - トランザクションハッシュをコピー

3. **履行証跡の提出**:
   - 該当義務の詳細ページを開く
   - 「Submit Evidence」ボタン
   - トランザクションハッシュまたは領収書ハッシュを入力
   - 「Mark as Fulfilled」

4. **自動ステータス更新**:
   - システムがブロックチェーンで支払を検証
   - 自動で「FULFILLED」にステータス変更
   - 関係者に完了通知

5. **月次レビュー**:
   - 全義務の履行状況を確認
   - 未履行義務がある場合は担当者に確認
   - 必要に応じてエスカレーション

### 6.3 基本操作ガイド

#### 契約のアップロードと解析
1. **ファイルの準備**: PDF、Markdown、またはテキスト形式の契約書を用意
2. **AIへの投入**: ドラッグ＆ドロップでアップロード。AIがパースを開始
3. **確認と修正**: 抽出された義務をカレンダービューで確認、必要に応じて手動調整

#### 版管理と署名
1. **ドラフトの履歴管理**: 交渉の過程で修正が生じるたびに新しい版を管理
2. **MetaMaskによる署名**: 各版の SHA-256 ハッシュに対して MetaMask で署名
3. **信頼の証跡**: ブロックチェーン上の署名データが真正性を証明

#### AI による Redline（赤字）交渉支援
1. **差分比較**: 修正案をアップロードし前の版と比較
2. **リスク診断**: AI が「損害賠償額が無制限に」等のリスクを指摘
3. **スマートな対案**: AI に有利な代替案をドラフトさせ交渉を加速

#### プライバシー保護下のオンボーディング (ZK Onboarding)
1. **秘密の保持**: 自分のデバイスで本人確認値を入力
2. **数学的証明**: PC 内で ZK 証明が生成
3. **情報の非開示**: サーバーには証明書だけが送られ個人情報は非開示

#### x402 による自動決済と義務履行
1. **解析料の支払い**: AI解析実行時に MetaMask で JPYC を支払い (Pay-per-Use)
2. **義務の自動消化**: オンチェーン支払が検知されるとステータスが自動更新
3. **リアルタイム監視**: カレンダーで常に同期し不履行リスクをゼロに


---
## 7. 免責事項 & ライセンス
### 7.1 免責事項
本プロダクトは、法務実務を補助するAIエージェントであり、AIの出力結果が常に正確であることは保証されません。最終的な署名や送金判断は、必ず人間が判断を行ってください。

### 7.2 ライセンス
MIT License / Copyright © 2025 LexFlow Protocol Project

---
**LexFlow Protocol: The Intelligent Layer for Legal Engineering.**
