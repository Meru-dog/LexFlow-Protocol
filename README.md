# LexFlow Protocol: 自律型法務エージェント & 決済統合プラットフォーム

LexFlow Protocolは、AI（LLM）とブロックチェーン技術を極限まで統合した、次世代の契約管理・履行・自動決済プラットフォームです。契約ドキュメントを「死んだテキスト」から「自律的に実行される動的なプログラマブル・コントラクト」へと進化させ、法務・財務・技術の三位一体を実現します。

---

## 1. プロジェクト全体像 (Overall Vision)

### 1.1 プロジェクトの目的
企業活動における「契約」は、締結して終わりではなく、その後の「履行管理」と「決済」が本質です。しかし、現状はこれらが完全に分断されており、多大な事務コストとリスクを生んでいます。LexFlowは、AI判定とオンチェーン証跡を用いてこれらを完全に同期させ、**「トラストレスな契約履行」**を自動化します。

### 1.2 ターゲットユーザー
- **法律事務所 / インハウス法務**: 数千件に及ぶ契約義務の抜け漏れ防止と、交渉プロセスの効率化。
- **ベンチャーキャピタル / スタートアップ**: SAFEや投資契約におけるマイルストーン管理と、JPYC等のステーブルコインによる迅速な決済。
- **サプライチェーン管理**: 検収後の自動支払フローの構築。

---

## 2. 機能要件

### 📄 AI 契約書解析 & スキーマ化
*   **意義**: 契約書という「非構造化された巨大なテキストデータ」を、後続のプログラムやスマートコントラクトが直接処理可能な、高精度の「デジタル資産（スキーマ化データ）」へと即座に変換します。
*   **実装内容**: `backend/app/services/contract_parser.py` を核とし、GPT-4モデルを高度に制御。単なるOCR（文字認識）ではなく、LangGraphを用いたマルチエージェント・ワークフローにより、契約当事者、条項の階層構造、法的期限、マイルストーン、金額、準拠法といった重要変数を、法的な文脈（Context）を理解した上で抽出します。
*   **技術的特徴**: 
    - **マルチ形式対応**: PDF/Markdown/Text を透過的に扱う抽象化レイヤー。
    - **セマンティック・パース**: プロンプト内で Pydantic スキーマを動的に定義し、AIの出力を厳格にバリデーション。
    - **LLM Context Window の最適化**: 大規模な契約書でも、重要なセグメントを特定して解析する抽出アルゴリズム。
*   **効果**: 従来、法務担当者が数時間を要していた契約情報の整理を数十秒に短縮し、ヒューマンエラーによる重要期限の見落としリスクを極限まで低減します。
*   **ワークフロー**: ファイルアップロード → テキストセグメンテーション → AIマルチステップ解析 → 構造化JSON生成 → DB永続化。

### 📅 AI 義務カレンダー & 履行管理
*   **意義**: 契約締結後に発生する膨大な「法的義務」の履行状況を自動で可視化・追跡し、契約の形骸化（締結して終わり）を防ぎます。
*   **実装内容**: `backend/app/services/obligation_service.py` が F1 の解析結果を受け取り、日付に基づいたタイムラインを生成。特定の義務（支払・通知・報告）に対して、それらが「いつまでに、誰によって担われるか」を自動管理。F8（支払ゲートウェイ）と統合されており、オンチェーンでの支払完了を検知すると、自動的に「履行済み」へとステータスを遷移させます。
*   **技術的特徴**:
    - **動的依存関係**: 前段のタスク完了が後段のマイルストーンのトリガーとなる「法的ワークフロー」のシミュレート。
    - **証跡（Evidence）ベース判定**: 履行を証明するためのドキュメントやトランザクションハッシュとの紐付け。
*   **効果**: 支払遅延や報告漏れによる契約違反リスクの排除。関係者全員が「今、誰が何をすべきか」をリアルタイムで同期可能。
*   **ワークフロー**: 解析データ受領 → 義務項目・期限の抽出 → カレンダー同期 → 証跡提出/支払検知 → 履行証明の完了。

### ✍️ EIP-712 暗号署名 & 不変版管理
*   **意義**: 中央集権的なドキュメント管理サーバーに依存せず、数学的かつ暗号学的な手法（ブロックチェーン技術）を用いて、合意内容の改ざん不能性と真正性を保証します。
*   **実装内容**: `backend/app/services/signature_service.py` およびフロントエンドの MetaMask 連携により、EIP-712（Typed Structured Data Hashing and Signing）規格を採用。ユーザーは MetaMask の画面上で、これから署名する内容（契約ID、ドキュメントハッシュ、タイムスタンプ等）を構造化された平易な情報として確認し、秘密鍵で署名を行います。
*   **技術的特徴**:
    - **真正性検証**: バックエンドにて Python の `eth-account` ライブラリを使用し、`ecrecover` で署名からウォレットアドレスを復元、当事者の一致を数学的に証明。
    - **SHA-256 版管理**: ドキュメントの内容が1文字でも変わればハッシュが変化するため、どの版に対して署名がなされたかを一意に特定。
*   **効果**: 署名済みドキュメントの「後出しの改ざん」が不可能になり、電子署名プラットフォーム（Docusign等）のコストを削減しつつ、より強固な証跡を構築。
*   **ワークフロー**: ドキュメント更新 → SHA-256ハッシュ計算 → EIP-712データ構築 → MetaMask署名 → バックエンド鍵復元・検証 → 署名データ保存。

### 🤖 Redline AI 交渉エージェント
*   **意義**: 契約交渉における最大のボトルネックである「相手方からの修正案の精査」をAIが支援し、法的リスクの早期発見と合意形成の加速を実現します。
*   **実装内容**: `backend/app/services/redline_service.py` において、`difflib` によるテキストベースの差分抽出と、LLM による意味論的なリスク評価を統合。単なる「文字の変化」ではなく、「この修正によって損害賠償の上限が撤廃されている」といった法的実質を伴う変化を AI が検出します。
*   **技術的特徴**:
    - **リスク・スケーリング**: 各修正箇所に対し、有利・不利・中立の判定と「Low/Medium/High」のリスクレベルを自動割り当て。
    - **代替案（Counter-proposal）生成**: 不利な修正に対し、自社のポリシーに基づいた修正案をAIが即座にドラフト。
*   **効果**: 法務チェックのリードタイムを最大 70% 削減。高度な法的知識がない担当者でも、修正案の意図を即座に把握可能。
*   **ワークフロー**: 複数バージョンのドキュメント比較 → 差分（追加・削除・変更）抽出 → AIリスクアセスメント → 提案・ダッシュボード表示。

### 🛡️ ZK プライバシーオンボーディング (Privacy KYC/COI)
*   **意義**: 「特定の資格や属性を持っている」という事実を、その根拠となる個人情報や重要機密（顧客リスト等）を一切サーバーに開示することなく、数学的に証明（Zero-Knowledge Proof）します。
*   **実装内容**: `contracts/zk/` の Circom 回路を使用し、クライアントサイドで証明を生成。例えば、利益相反（Conflict of Interest）チェックにおいて、弁護士は自分の顧客リストという「秘密」を入力としつつ、今回の相手方がそのリストに含まれていないという証明のみを発行します。
*   **技術的特徴**:
    - **Groth16 ZK-SNARKs**: 非常に軽量で高速な検証が可能なアルゴリズムを採用。
    - **SnarkJS 統合**: ブラウザ上（WASM）で証明を生成し、サーバー側（`backend/app/services/zk_verifier.py`）で検証する非中央集権的な設計。
*   **効果**: サーバーがハッキングされたとしても、元データ（個人情報や顧客リスト）が存在しないため、漏洩リスクが物理的に存在しません。
*   **ワークフロー**: ユーザーの秘密情報入力（ローカル環境） → ZK証明生成（WASM） → 証明とパブリック信号の送信 → バックエンドでの数学的妥当性検証。

---

## 3. ZK(ゼロ知識証明)のビジネスロジックと信頼モデル

LexFlowにおけるZK機能は、単なる暗号化技術ではなく、新しい「信頼の形」を提供します。

### 3.1 ZK KYC: 「審査なし」ではなく「検証の分離」
「入力データを開示せずにKYCができる」というのは、**審査を省くという意味ではありません。**
- **モデル**: 信頼できる第三者機関（Identity Provider: 政府公認のデジタルIDサービスや、免許証・パスポートを認証する民間機関）が事前に厳格な審査を行い、ユーザーに本人しか知り得ない「秘密鍵（Identity Secret）」とそのハッシュを紐付けて発行します。
- **LexFlowの役割**: LexFlowは個人情報を直接見る代わりに、「あなたが正式な審査を通過した証（Secret）を所有していること」という**証明（Proof）のみを数学的に検証**します。
- **メリット**: LexFlowは高いコンプライアンス要件を満たしつつ、ハッキング時の個人情報流出リスクを「物理的にゼロ」にできます。

### 3.2 利益相反(COI)チェックの活用例: 「対立する相手方」との照合
弁護士が新規案件を受任する際、以下の問題を解決します。
- **課題**: 相手方の名前が「過去の顧客リスト（機密）」にあるか確認したいが、顧客リスト自体を第三者のシステムにアップロードすることは守秘義務違反になる。
- **ZKの活用**: 
    1. 自分のPC内で既存顧客リスト（秘密）と、今回の案件の「相手方（Adverse Party）」の名前を照合。
    2. ZK証明を生成。「リストには今回の相手方が含まれていない」という事実だけを証明。
    3. リスト自体は一度もネットワークに出ることなく、受任処理を安全に進められます。

### 3.3 履行状態証明 (Fulfillment Proof): 金銭以外の義務の完了
LexFlowでは支払いは JPYC（ステーブルコイン）で行われますが、ZK履行証明は「支払い以外の条件」が満たされたことを証明するために使用します。
- **活用例**:
    - **物理的納品**: 倉庫への商品搬入が完了した際、署名済みの受領書ハッシュを証拠として履行を証明。
    - **機密データ提供**: NDA下のソースコードや設計図が共有された事実を、データ自体をブロックチェーンに載せずに証明。
    - **KPI達成**: 非公開の財務データやユーザー数が目標値を超えたことを、詳細な数値を伏せたまま証明。
- **ワークフロー**: あらかじめ合意した証拠のハッシュ（Expected Hash）に対し、手元の生データが一致することを数学的に証明します。

---
### 💳 x402 ネイティブ支払ゲートウェイ
*   **意義**: 「価値のあるリサーチや解析」と「その対価の支払い」を、HTTPプロトコルレベルで原子性（Atomicity）を持たせ、Web3時代の「Pay-per-Use」を実現します。
*   **実装内容**: `backend/app/core/x402.py` の `PaymentVerifier` クラスを FastAPI の依存関係（Dependency Injection）として組み込み。特定のエンドポイント（AI解析等）に対し、実行前に JPYC 等のステーブルコインの支払いを要求（HTTP 402 Payment Required）します。
*   **技術的特徴**:
    - **オンチェーン検証**: トランザクションハッシュをヘッダーに乗せ、バックエンドが RPC 経由でブロックチェーン（Sepolia等）をスキャンし、正しい宛先・金額が着金しているかをリアルタイム検証。
    - **二重プレフィックス防止と同期管理**: 同一トランザクションの使い回しやネットワーク不整合を考慮した堅牢なセキュリティ。
*   **効果**: 未払い・回収不能リスクがゼロ。APIキーの販売・管理といった中央集権的な手間を省き、仮想通貨ウォレット一つでグローバルな法的サービスの利用を可能に。
*   **ワークフロー**: APIリクエスト → 402未払い検知 → MetaMask決済ポップアップ → トランザクション送信 → 再リクエスト（Hash付） → 着金検証成功 → 解析結果返却。

### 🔐 認証・ウォレット連携
*   **意義**: ユーザー認証とウォレット認証を組み合わせた二要素認証相当のセキュリティを提供し、契約書へのアクセスを厳格に管理します。
*   **実装内容**: `backend/app/api/auth.py` および `backend/app/services/auth_service.py` により、メール/パスワードでのサインアップ・ログインと、MetaMask署名によるウォレット紐付けを実現。
*   **技術的特徴**:
    - **JWT認証**: アクセストークン（24時間）とリフレッシュトークン（7日間）の二層構造。
    - **Nonce署名**: ウォレット連携時にリプレイ攻撃を防ぐワンタイムnonceを生成。
    - **bcryptハッシュ**: パスワードは業界標準のbcryptで不可逆的にハッシュ化。
*   **効果**: 「誰がログインしたか」と「そのウォレットを本当に所有しているか」を二段階で証明可能。
*   **ワークフロー**: サインアップ → メール確認 → ログイン → ウォレットnonce取得 → MetaMask署名 → ウォレット紐付け完了。

### 👥 RBAC・契約書ACL
*   **意義**: 法律事務所で必須の「役割ベースアクセス制御（RBAC）」と、契約書単位での細かなアクセス制御（ACL）を提供します。
*   **実装内容**: `backend/app/api/rbac.py` にて、ワークスペース（テナント）管理、6種類の標準ロール（Owner/Admin/Manager/Member/Approver/Auditor）、16種類の権限キー、契約書単位のview/edit/approve権限を管理。
*   **技術的特徴**:
    - **カスタムロール**: 標準ロールに加え、組織独自のロールを自由に定義可能。
    - **権限継承**: ユーザー直接付与 > ロール付与 の優先順位で権限を判定。
    - **監査ログ連携**: すべての権限変更は監査イベントとして記録。
*   **効果**: 「このパートナーは全件閲覧可能、このアソシエイトはこの案件のみ編集可能」といった複雑な権限構造を実現。
*   **ワークフロー**: ワークスペース作成 → 標準ロール自動初期化 → ユーザー招待 → ロール割当 → 契約書ACL設定 → アクセス制御適用。

### ✅ 承認フロー・マジックリンク
*   **意義**: 複数人・順序付き・条件分岐に対応した承認プロセスを構築し、「誰がいつ何を承認したか」の完全な証跡を残します。
*   **実装内容**: `backend/app/api/approvals.py` にて、承認フローテンプレート（再利用可能）、承認リクエスト、承認タスク、マジックリンク（外部承認者向けワンタイムURL）を管理。
*   **技術的特徴**:
    - **マルチステージ承認**: 並列（同時に依頼）・順序付き（1→2→3...）・混在の柔軟な設計。
    - **条件分岐**: 契約金額や相手方名に基づき、自動で承認者を追加・スキップ。
    - **マジックリンク**: 外部承認者（取引先担当者など）はログイン不要でセキュアに承認可能（有効期限・失効機能付き）。
*   **効果**: 「100万円以上は法務部長の承認必須」といった業務ルールをシステム化し、承認の抜け漏れを防止。
*   **ワークフロー**: テンプレート作成 → 承認リクエスト発行 → タスク生成 → マジックリンク送信 → 承認/否認/差戻し → ステータス更新。

### 📋 監査証跡・ハッシュチェーン
*   **意義**: すべての重要操作を改ざん不能な形で記録し、内部監査・外部監査・訴訟対応に即座に対応できる証跡基盤を構築します。
*   **実装内容**: `backend/app/api/audit.py` および `backend/app/services/audit_service.py` により、30種類以上のイベントタイプ（ログイン/権限変更/契約書操作/承認アクション等）を記録。各イベントはSHA-256ハッシュチェーンで連結。
*   **技術的特徴**:
    - **ハッシュチェーン**: 各イベントは前のイベントのハッシュを含み、過去のログを改ざんするとチェーンが破綻。
    - **整合性検証API**: `/audit/verify` エンドポイントでいつでもチェーンの整合性を数学的に検証可能。
    - **詳細フィルタ**: 期間/ユーザー/契約書/イベントタイプでの高度な検索。
*   **効果**: 「誰がいつ何をしたか」を完全に追跡可能。監査法人への証跡提出が即座に可能。
*   **ワークフロー**: 操作発生 → イベント生成 → ハッシュ計算 → 前ハッシュとチェーン化 → DB永続化 → 検索・検証。

### 📧 通知システム
*   **意義**: 承認依頼・期限リマインド・結果通知をメール/Slackで確実に届け、業務の「待ち」を最小化します。
*   **実装内容**: `backend/app/api/notifications.py` および `backend/app/services/notification_service.py` により、Email（SendGrid/SMTP対応設計）とSlack（Webhook連携）への通知を管理。
*   **技術的特徴**:
    - **テンプレートエンジン**: 承認依頼/リマインドの本文を自動生成（HTML/プレーンテキスト/Slackブロック形式）。
    - **リトライ機構**: 送信失敗時の自動リトライと手動再送機能。
    - **通知ログ**: すべての送信試行を記録し、トラブルシューティングを支援。
*   **効果**: 「承認が止まっている」「誰が見ていないか分からない」という問題を解消。
*   **ワークフロー**: イベント発生 → 通知ペイロード生成 → チャンネル選択 → 送信試行 → ログ記録 → （失敗時）リトライ。

---

## 3. 実装方法 (Implementation Detail)

### 3.1 AI解析ワークフロー (LangGraph)
AIは複数のエージェント（解析・検証・整形）に分かれて動作します。
1.  **解析エージェント**: PDFからテキストを抽出し、法的なエンティティ（条項、金額、期日）を特定。
2.  **検証エージェント**: 抽出されたデータが契約本文のどこに基づいているか（根拠条項）をクロスチェック。
3.  **スキーマ生成**: 最終的なJSONデータを生成し、バックエンドへ受け渡し。

### 3.2 ブロックチェーン & 署名 (EIP-712)
`eth-account` (Python) と `ethers.js` (TypeScript) を使用して、以下のドメイン・タイプ定義を共有しています。
*   **Domain**: `name: "LexFlow Protocol"`, `version: "1"`, `chainId: 11155111`
*   **Message**: `caseId`, `version`, `docHash`, `timestamp`
*   **Verification**: バックエンドが `ecrecover` を実行し、復元されたアドレスが署名者と一致するか検証。

### 3.3 支払ゲートウェイ (x402)
FastAPIの依存関係注入（Dependency Injection）を利用して、特定のエンドポイントに `PaymentVerifier` を適用しています。
- 未払い時は `402 Payment Required` を送出し、フロントエンドで自動的に MetaMask 決済モーダルを起動。
### 3.4 ゼロ知識証明 (ZK Proofs)
`circom` と `snarkjs` を使用したプライバシー保護機能が `contracts/zk/` に実装されています。
*   **KYC検証**: 身元情報を開示せず、有効なプロバイダーにより承認されたKYCを保持していることを数学的に証明。
*   **利益相反チェック**: クライアントリスト（秘密）の中に、新規案件の相手方が含まれていないことを証明。
*   **詳細**: セットアップ方法については後述の [4.5 ゼロ知識証明のセットアップ](#45-ゼロ知識証明のセットアップ-zk-proofs-setup) を参照してください。

---

## 4. デプロイ方法 (Deployment Guide)

### 4.1 Prerequisites
- Python 3.9+
- Node.js 18+
- MetaMaskウォレット（Sepolia TestnetにJPYC/ETHがあること）

### 4.2 バックエンドの起動
```bash
cd backend
python -m venv venv
source venv/bin/activate
pip install -r requirements.txt
# .envの設定 (OPENAI_API_KEY, ETHEREUM_RPC_URL)
uvicorn app.main:app --reload --port 8000
```

### 4.3 フロントエンドの起動
```bash
cd frontend
npm install
# .envの設定 (VITE_API_URL=http://localhost:8000/api/v1)
npm run dev
```

### 4.4 スマートコントラクトのセットアップ (Smart Contracts Setup)
1. `contracts` ディレクトリへ移動して依存関係をインストール:
   ```bash
   cd contracts
   npm install
   ```
2. 環境変数の設定:
   `.env.example` を `.env` にコピーし、RPC URL とプライベートキーを設定してください。
3. コントラクトのコンパイルとテスト:
   ```bash
   npm run compile
   npm run test
   ```

### 4.5 ゼロ知識証明のセットアップ (ZK Proofs Setup)
1. `circom` のインストール (未完了の場合):
   ```bash
   # Rustがインストールされていない場合
   curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
   
   # Circomのインストール
   git clone https://github.com/iden3/circom.git
   cd circom
   cargo build --release
   cargo install --path circom
   ```
2. `contracts/zk` ディレクトリで依存関係をインストールし、Powers of Tau をダウンロード (プロジェクトのルートから実行):
   ```bash
   cd contracts/zk
   npm install
   # 信頼できるミラーサイトからダウンロード（より大きな回路に対応するため _12 を使用）
   curl -L https://storage.googleapis.com/zkevm/ptau/powersOfTau28_hez_final_12.ptau -o powersOfTau28_hez_final_12.ptau
   ```
3. 回路のコンパイルと信頼セットアップ:
   ```bash
   npm run compile:all
   npm run setup:all
   npm run export:all
   ```

---

## 5. ロードマップ (Roadmap)
- **Phase 1**: 基盤構築（PDF解析・エスクロー） [Done]
- **Phase 2**: V2機能統合（義務管理、x402、AI Redline） [Done]
- **Phase 3**: プライバシー & 高度な自動化（ZK Proofs、法的プレイブック学習、RBAC） [In Progress]
    - ZK Onboarding (KYC / COI) 回路実装済
    - バックエンド検証サービス実装済

---

## 6. ユーザーガイド (User Guide)

LexFlow Protocol を使った契約管理の具体的な流れを、ユーザー体験（UX）に沿って解説します。

### 6.1 契約のアップロードと解析 (Upload & Analyze)
1.  **ファイルの準備**: PDF、Markdown、またはテキスト形式の契約書を用意します。
2.  **AIへの投入**: ドラッグ＆ドロップでアップロード。AIが即座にパースを開始し、マイルストーンや支払条件を構造化データとして抽出します。
3.  **確認と修正**: AIが抽出した「義務（支払期日や内容）」をカレンダービューで確認。必要に応じて手動で調整し、合意のベースラインを確定させます。

### 6.2 版管理と署名 (Versioning & Signing)
1.  **ドラフトの履歴管理**: 交渉の過程で修正が生じるたびに、新しい版を「Case」として管理します。
2.  **MetaMaskによる署名**: 各版の SHA-256 ハッシュに対して MetaMark で署名を付与。これにより、「誰がどの版に最終合意したか」が暗号学的に固定されます。
3.  **信頼の証跡**: サーバーを信用する必要はありません。ブロックチェーン上の署名データが、その契約の真正性を数十年先まで証明し続けます。

### 6.3 AI による Redline（赤字）交渉支援
1.  **差分比較**: 相手方から送られてきた修正案をアップロードし、前の版と比較します。
2.  **リスク診断**: 「この追加条項は、当社の損害賠償額を無制限に広げるリスクがあります」といった AI の解説を読みます。
3.  **スマートな対案**: 判断に迷った際は、AI に「自社にとってより有利、かつ公平な代替案」をドラフトさせ、交渉を加速させます。

### 6.4 プライバシー保護下のオンボーディング (ZK Onboarding)
1.  **秘密の保持**: 自分のデバイスで、本人確認値（Identity Secret）を入力します。
2.  **数学的証明**: PC 内で ZK 証明（Proof）が生成されます。
3.  **情報の非開示**: サーバーには「証明書」だけが送られ、あなたの個人情報は一切送信されませんが、システムはあなたが「KYC済みであること」を確信し、利用を許可します。

### 6.5 x402 による自動決済と義務履行
1.  **解析料の支払い**: 高度なAI解析を実行する際、MetaMask 等で少額の JPYC を支払います（Pay-per-Use）。
2.  **義務の自動消化**: 特定の義務（例：マイルストーン1の完了）に対応するオンチェーン支払が検知されると、管理画面のステータスが自動的に「履行済み」へと切り替わります。
3.  **リアルタイム監視**: 誰が今何をすべきか、何が未完了かをカレンダーで常に同期し、不履行リスクをゼロにします。

---

## 7. ライセンス & 免責事項
### 6.1 免責事項
本プロダクトは、法務実務を補助するAIエージェントであり、AIの出力結果が常に正確であることは保証されません。最終的な署名や送金判断は、必ず人間が判断を行ってください。

### 6.2 ライセンス
MIT License / Copyright © 2025 LexFlow Protocol Project

---
**LexFlow Protocol: The Intelligent Layer for Legal Engineering.**
