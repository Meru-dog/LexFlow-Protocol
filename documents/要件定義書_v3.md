# 要件定義書_v3（LexFlow Protocol：認証・権限・承認・課金/JPYC・通知）

## 0. 文書情報

* 文書名：要件定義書_v3
* 対象プロダクト：LexFlow Protocol（契約書アップロード→AI解析→ブロックチェーン登録/承認）
* 作成日：2025-12-30
* 作成者：meru
* 目的：下記機能群の実装要件（機能/非機能/データ/画面/運用）を定義し、開発・QA・運用の共通認識を作る。

---

## 1. 背景・課題

* 契約書の閲覧/編集/承認を「ユーザー認証＋ウォレット認証」により担保し、役割や契約書単位での権限管理を行いたい。
* 承認プロセスを複数人・順序・条件分岐に対応させ、監査証跡を残したい。
* AI解析やストレージ等の利用に応じたプラン/課金と、JPYCによる決済（サブスク/従量/返金/請求書）を提供したい。
* メール/Slack/Discord/アプリ内の通知で承認依頼・期限・リマインド等を確実に届けたい。

---

## 2. スコープ

### 2.1 本要件の対象（In Scope）

1. ユーザー認証とウォレット認証（2FA相当の二要素として扱う想定含む）
2. 役割ベース権限（RBAC）
3. 契約書ごとの閲覧・編集・承認権限（ABAC/リソースベースACLを併用）
4. メタデータ編集（タイトル/相手先/期間/担当者/タグ/案件番号/契約書データ）
5. 承認依頼の送付（リンク発行、期限、リマインド）
6. 複数承認（2名以上、順序付き、条件分岐）
7. 承認の監査証跡（誰がいつ何を承認したか）
8. プラン/課金（解析回数、ユーザー数、ストレージ、機能制限）
9. JPYCでの支払い/精算（サブスク、従量、返金、請求書）
10. メール/Slack/Discord/アプリ内通知

### 2.2 対象外（Out of Scope）

* 契約書本文の全文編集機能（注釈/コメントは将来検討）
* AIモデル精度改善、学習パイプラインの詳細
* 反社チェック等の外部コンプライアンス連携（将来検討）
* 電子署名法対応の“法的署名”機能（承認は業務承認に限定）

---

## 3. 用語定義

* **ユーザー**：メール等でアカウントを持つ利用者
* **ウォレット**：EVM互換アドレス等。署名により本人性/所有を確認
* **ワークスペース（Workspace）**：企業/チーム単位のテナント
* **RBAC**：役割（Role）に基づく権限
* **ACL**：契約書（Contract）単位のアクセス制御
* **承認フロー（Approval Flow）**：承認者・順序・分岐条件を持つ定義
* **承認タスク（Approval Task）**：実行時に生成される承認依頼
* **監査証跡（Audit Trail）**：操作ログ・承認ログの改ざん耐性を担保した記録
* **解析回数**：AI解析の実行回数（アップロード/再解析/再抽出等の定義は後述）
* **JPYC決済**：JPYC（安定通貨）を用いた支払/返金/精算

---

## 4. 想定ユーザー・役割（RBAC）

### 4.1 標準ロール（初期提供）

* **Owner**：ワークスペース管理者。課金/ユーザー管理/権限設計/監査閲覧の全権限
* **Admin**：ユーザー・権限・通知設定管理。課金は閲覧のみ（設定変更不可）
* **Manager**：契約書の作成/編集/承認フロー設計が可能。ユーザー管理不可
* **Member**：割り当てられた契約書の閲覧/編集（範囲指定）/承認が可能
* **Approver（外部/社内）**：承認のみ（閲覧範囲限定）。リンク承認でログインなしも選択可
* **Auditor/Viewer**：閲覧専用＋監査ログ閲覧（契約書本文閲覧は別途ACLで制御）

### 4.2 ロールはカスタム可能（v3要件）

* Owner/Adminが「ロール作成」「権限付与」「ロール割当」可能
* 権限は「機能権限（例：ユーザー招待）」と「リソース権限（例：契約書閲覧）」に分けて管理

---

## 5. 機能要件

### 5.1 認証（ユーザー認証＋ウォレット認証）

#### 5.1.1 ユーザー認証

* メール＋パスワード、もしくはSSO（将来）を想定。v3では以下を必須：

  * サインアップ（メール確認）
  * ログイン/ログアウト
  * パスワード再設定
  * セッション管理（有効期限、リフレッシュ）
* セキュリティ要件

  * パスワードは強度ルール（最小文字数、英数記号など）
  * ログイン試行回数制限/レート制限
  * 重要操作時の再認証（例：請求先変更、返金）

#### 5.1.2 ウォレット認証（Wallet Connect）

* ユーザーは1つ以上のウォレットを紐付け可能
* ウォレット紐付けは「メッセージ署名（nonce付き）」で所有確認
* ウォレット認証の使い分け

  * (A) **ログイン補助**：ログイン後にウォレットを接続して署名
  * (B) **強制二要素**：特定ロール（Owner等）や特定操作（ブロックチェーン登録/承認確定）で署名必須
  * (C) **承認本人性**：承認アクション時に署名必須（社内方針でON/OFF）
* 署名メッセージは「目的」「契約書ID」「ワークスペース」「期限」を含む（リプレイ防止）
* ウォレット変更/削除は再認証必須

---

### 5.2 権限管理（RBAC＋契約書単位ACL）

#### 5.2.1 役割ベース権限（RBAC）

* 権限カテゴリ

  * ワークスペース管理：ユーザー招待/削除、ロール管理、監査閲覧
  * 契約書管理：作成、アップロード、編集、削除、アーカイブ
  * 承認管理：フロー設計、依頼送付、再送、期限変更、差戻し
  * 課金管理：プラン変更、支払方法、請求書、返金
  * 通知管理：チャンネル連携、テンプレ編集（※編集はv3ではオプション）
* ロールに権限を紐付け、ユーザーは複数ロールを持てる（ワークスペース単位）

#### 5.2.2 契約書単位の閲覧・編集・承認権限（ACL）

* 契約書（Contract）ごとに以下の権限を付与可能：

  * **View**：閲覧
  * **Edit Metadata**：メタデータ編集
  * **Edit Document**：契約書データ差し替え/再解析（v3では「差し替え」扱い）
  * **Request Approval**：承認依頼作成/送付
  * **Approve**：承認/否認/差戻し
  * **Audit View**：当該契約書の監査ログ閲覧
* 付与対象：ユーザー / ロール / 外部承認者（メール or ウォレット）
* デフォルト継承

  * 契約書作成者：View/Edit/Request Approval
  * Owner/Admin：ポリシーにより全件閲覧可 or 明示付与（ワークスペース設定で選択）

#### 5.2.3 権限判定ルール（優先順位）

* 明示的な拒否（Deny）があれば常に優先（将来拡張）
* 付与（Allow）は「ユーザー直接付与」>「ロール付与」>「チーム（将来）」の順
* 監査ログには「判定根拠（どのロール/ACLで許可されたか）」を記録

---

### 5.3 契約書メタデータ編集

#### 5.3.1 管理対象メタデータ（必須）

* タイトル（string）
* 相手先（company/person name）
* 期間（開始日/終了日、もしくは自動更新/無期限フラグ）
* 担当者（user_id参照、複数可）
* タグ（自由入力＋候補、複数可）
* 案件番号（string、ユニーク制約はワークスペース設定）
* 契約書データ

  * 原本PDF（ファイル）
  * 解析結果（抽出テキスト/条項/金額等、構造化JSON）
  * バージョン（差し替え履歴）

#### 5.3.2 操作要件

* メタデータ編集は履歴を保持（誰がいつ何を変更したか）
* 編集後に「保存」「下書き」「承認依頼へ進む」を選べる
* 期間/金額などは入力バリデーション（形式/範囲）
* タグはワークスペース共通辞書を持てる（任意）

---

### 5.4 承認依頼の送付（リンク発行、期限、リマインド）

#### 5.4.1 承認依頼の作成

* 承認依頼作成時に指定可能：

  * 対象契約書
  * 承認フロー（テンプレ or 都度）
  * 期限（日時、タイムゾーン）
  * リマインド設定（例：期限3日前/1日前/当日、または毎日）
  * 通知チャネル（メール/Slack/Discord/アプリ内）
* 依頼作成者は「依頼メッセージ（任意）」を添付可能

#### 5.4.2 リンク承認（Magic Link）

* 承認者に**ワンタイムリンク**を発行

  * 有効期限つき
  * 1回使用 or 有効期限内複数回（設定）
  * クリック後に本人確認（メールコード or ウォレット署名）を要求できる
* セキュリティ

  * トークンは推測困難、漏洩時の失効が可能
  * 失効/再発行時は旧リンク無効化

#### 5.4.3 リマインド

* リマインドは以下で送信：

  * 未対応の承認者
  * 期限超過の承認者（エスカレーションも将来検討）
* 通知ログ（いつ・どこに・結果）を保存

---

### 5.5 複数承認（順序付き、条件分岐）

#### 5.5.1 基本要件

* 承認者は2名以上を設定可能
* 承認方式

  * **順序付き（Sequential）**：1→2→3…
  * **並列（Parallel）**：全員同時に依頼
  * **混在（Stage）**：ステージ単位に並列、その後次ステージへ
* 合否条件

  * 全員承認で可決
  * 過半数承認で可決（v3ではオプション）
  * 1名でも否認で否決
  * 差戻し時の再提出フロー（同じ承認者に再依頼 or 作成者に戻す）

#### 5.5.2 条件分岐

* 条件はメタデータ/解析結果を参照できる：

  * 総額（例：100万JPYC以上なら法務必須）
  * 相手先（ブラックリスト/重要取引先）
  * 期間（1年以上なら追加承認）
  * タグ/案件番号/担当者
* 分岐定義

  * ルール（if/else）により承認者追加/スキップ/順序変更
* ルール評価タイミング

  * 依頼作成時（初回固定）
  * もしくはメタデータ変更時に再評価（v3は「依頼作成時固定」を基本）

#### 5.5.3 承認アクション

* 承認：承認コメント（任意）＋（必要なら）ウォレット署名
* 否認：理由入力（必須）＋（必要なら）署名
* 差戻し：差戻し理由（必須）、差戻し先（作成者/特定ユーザー）

---

### 5.6 監査証跡（誰がいつ何を承認したか）

#### 5.6.1 記録対象イベント

* 認証：ログイン/失敗/再認証/ウォレット紐付け/署名
* 権限：ロール変更、ACL付与/剥奪、設定変更
* 契約書：作成、アップロード、差し替え、メタデータ変更、削除/アーカイブ
* 承認：依頼作成、リンク発行/失効、通知送信、承認/否認/差戻し、期限変更
* 課金：プラン変更、支払い成功/失敗、返金、請求書発行

#### 5.6.2 監査ログ要件

* 各イベントに最低限含む：

  * event_id, event_type, workspace_id, contract_id（該当時）
  * actor（user_id / external_id / wallet_address）
  * timestamp（UTC）
  * action_detail（差分、承認結果、署名ハッシュ等）
  * ip / user_agent（可能なら）
* 改ざん耐性

  * v3ではDB保持＋ハッシュチェーン（イベント連結）を実装方針（オンチェーン記録は将来拡張）
* 監査閲覧

  * フィルタ（期間/契約書/ユーザー/イベント種別）
  * エクスポート（CSV）※v3オプション

---

### 5.7 プラン/課金（解析回数、ユーザー数、ストレージ、機能制限）

#### 5.7.1 プラン概念

* プランはワークスペース単位
* 制限項目

  * 月間解析回数（上限/超過従量）
  * アクティブユーザー数（席数）
  * ストレージ容量（原本PDF＋解析データ）
  * 機能制限（例：条件分岐、監査エクスポート、Slack通知など）

#### 5.7.2 計測定義（メータリング）

* 解析回数カウント：

  * 契約書アップロード時の解析を1回
  * 「再解析」ボタン/差し替えによる解析は各1回
  * メタデータ編集のみはカウントしない
* ユーザー数：

  * ワークスペースに所属する「アクティブユーザー（招待受諾済）」をカウント
  * 外部承認者（リンク承認のみ）は原則席に含めない（設定可能）
* ストレージ：

  * 原本PDFサイズ＋生成物（抽出JSON、サムネ等）を合算

#### 5.7.3 超過時挙動

* 解析回数超過：

  * 従量課金が有効なら実行可（後払い）
  * 無効なら実行不可（購入導線を提示）
* ストレージ超過：

  * アップロード不可、または追加ストレージ購入
* ユーザー席超過：

  * 新規招待不可、または追加席購入

---

### 5.8 JPYCでの支払い/精算（サブスク、従量、返金、請求書）

#### 5.8.1 支払いモデル

* サブスク（月額/年額）＋従量（解析超過/追加ストレージ/追加席）
* 支払いタイミング

  * サブスク：前払い（更新日課金）
  * 従量：月末締め翌日請求（もしくは都度デポジットから相殺）
* 支払い手段

  * JPYC送金（指定アドレス/スマートコントラクト）
  * 可能なら「支払参照ID」をメッセージ/トランザクションに紐付け

#### 5.8.2 請求・精算

* 請求書（Invoice）

  * ワークスペース、請求期間、内訳（基本料/従量）、合計JPYC
  * ステータス：Draft / Issued / Paid / Overdue / Voided
* 入金照合

  * オンチェーンTxを監視し、参照ID/金額/送信元で照合
  * 照合できない入金は「要対応」へ
* 精算（Refund）

  * 返金ルール：日割り/未使用分/不正利用など（v3は運用ルールとして別紙でも可）
  * 返金はJPYCで実行し、返金Txを請求書に紐付け
  * 返金はOwnerのみ実行可＋監査ログ必須

#### 5.8.3 失敗・例外

* 支払い不足/遅延：猶予期間後に機能制限（閲覧のみ等）
* 二重入金：次月繰越 or 返金
* 価格変更：次回更新から適用、事前通知

---

### 5.9 通知（メール/Slack/Discord/アプリ内）

#### 5.9.1 通知イベント

* 承認依頼作成
* リンク発行/再発行
* リマインド
* 承認/否認/差戻し
* 期限超過
* 契約書差し替え/再提出
* 課金：請求書発行、支払い成功/失敗、更新前通知、超過警告

#### 5.9.2 チャネル別要件

* **メール**

  * 宛先：ユーザーのメール、外部承認者メール
  * テンプレ：件名/本文（v3は固定テンプレ＋変数差し込み）
* **Slack**

  * ワークスペース連携（Webhook or OAuth）
  * チャンネル指定、メンション（任意）
* **Discord**

  * Webhook連携（チャンネルへの投稿）
* **アプリ内通知**

  * 通知一覧（未読/既読）
  * 契約書・承認タスクへのディープリンク

#### 5.9.3 送信品質

* 再送制御（重複抑止キー）
* 送信失敗のリトライ（指数バックオフ）
* 通知ログを保持（結果/エラー）

---

## 6. 画面要件（主要UI）

### 6.1 認証/設定

* ログイン/サインアップ/パスワード再設定
* プロフィール：メール、ウォレット管理（追加/削除）
* ワークスペース設定：ロール/ユーザー管理、通知連携、課金

### 6.2 契約書

* 契約書一覧：検索（タイトル/相手先/タグ/案件番号）、フィルタ（期間/ステータス/担当者）
* 契約書詳細：

  * 原本PDFビュー
  * メタデータ編集フォーム
  * 承認状況タイムライン
  * 監査ログ（権限がある場合）

### 6.3 承認

* 承認フロー作成（テンプレ管理）
* 承認依頼作成（期限/リマインド/通知）
* 承認者向けページ（リンク経由）

  * 契約書概要＋必要箇所
  * 承認/否認/差戻しボタン
  * 署名ステップ（必要時）

### 6.4 課金

* 現在のプラン、利用状況（解析回数/席/ストレージ）
* 請求書一覧、支払い状況
* JPYC入金先/参照IDの表示
* 返金申請/履歴（権限制御）

---

## 7. データ要件（概念モデル）

### 7.1 主要エンティティ

* Workspace(id, name, plan_id, billing_status, created_at…)
* User(id, email, password_hash, status…)
* Wallet(id, user_id, address, verified_at…)
* Role(id, workspace_id, name)
* Permission(id, key, description)
* RolePermission(role_id, permission_id)
* WorkspaceUser(workspace_id, user_id, role_id, status)
* Contract(id, workspace_id, creator_id, status, current_version_id…)
* ContractVersion(id, contract_id, file_url, file_hash, extracted_json, created_at…)
* ContractMetadata(contract_id, title, counterparty, start_date, end_date, owners[], tags[], matter_no…)
* ContractACL(contract_id, subject_type[user/role/external], subject_id, permissions[])
* ApprovalFlow(id, workspace_id, name, definition_json)
* ApprovalRequest(id, contract_id, flow_id, due_at, reminder_policy, status…)
* ApprovalTask(id, request_id, stage, assignee_type, assignee_id, status, acted_at, comment, signature_hash…)
* MagicLink(id, request_id/task_id, token_hash, expires_at, revoked_at…)
* Notification(id, channel, payload, status, sent_at, error…)
* AuditEvent(id, type, actor, workspace_id, contract_id, detail_json, prev_hash, hash, created_at…)
* Invoice(id, workspace_id, period, line_items, total_jpyc, status…)
* Payment(id, invoice_id, tx_hash, amount_jpyc, from_address, matched_at…)
* Refund(id, invoice_id/payment_id, tx_hash, amount_jpyc, reason, created_at…)

### 7.2 データ保持期間（案）

* 監査ログ：原則7年（設定可能）
* 通知ログ：6〜12ヶ月
* 契約書/解析データ：ワークスペース契約に準ずる（退会後の猶予期間を設ける）

---

## 8. API要件（例：主要エンドポイント）

* Auth

  * POST /auth/signup, /auth/login, /auth/logout
  * POST /auth/wallet/nonce, /auth/wallet/verify
* RBAC/ACL

  * GET/POST /roles, /roles//permissions
  * POST /contracts//acl
* Contract

  * POST /contracts (create), POST /contracts//upload
  * PATCH /contracts//metadata
  * POST /contracts//reanalyze
* Approval

  * POST /approvals/flows
  * POST /approvals/requests
  * POST /approvals/tasks//approve|reject|return
  * POST /approvals/magic-link//consume
* Billing/JPYC

  * GET /billing/usage, /billing/plan
  * GET /billing/invoices, POST /billing/invoices//issue
  * POST /billing/payments/match (webhook/cron)
  * POST /billing/refunds
* Notifications

  * POST /integrations/slack, /integrations/discord
  * GET /notifications (in-app)

※ 認可：全APIで「workspace_id」「role/acl判定」を行い、監査イベントを発火する。

---

## 9. 非機能要件

### 9.1 セキュリティ

* OWASP Top 10 対策（CSRF/SQLi/XSS/認可不備）
* 重要操作は再認証＋（必要なら）ウォレット署名
* Magic Linkの漏洩対策（短寿命、失効、デバイス指紋 optional）
* 監査ログの改ざん耐性（ハッシュチェーン）
* 秘匿情報（Webhook URL等）は暗号化保存

### 9.2 可用性・性能

* 通知/監査/課金照合は非同期ジョブで処理
* 承認ページの表示：p95 < 2秒（目標）
* 解析実行はキューイング（進捗/ステータス表示）

### 9.3 運用

* 監視：ジョブ失敗、通知失敗率、支払い未照合件数
* 管理画面：失敗通知再送、未照合入金の手動紐付け

---

## 10. 受入基準（Acceptance Criteria：抜粋）

1. ユーザーはメール認証後にログインでき、ウォレットを署名で紐付けられる
2. ロールにより管理機能の可否が切り替わり、契約書ACLにより同一画面でも閲覧/編集/承認の可否が変わる
3. 契約書メタデータ（タイトル/相手先/期間/担当者/タグ/案件番号/契約書データ）を編集でき、変更履歴が監査ログに残る
4. 承認依頼を作成すると、リンクが発行され期限/リマインド設定が有効になる
5. 2名以上・順序付き承認が実行でき、条件分岐ルールにより承認者が追加/スキップされる
6. 承認/否認/差戻しの「誰がいつ何を」が監査証跡として検索でき、改ざん検知（ハッシュチェーン整合）できる
7. プラン上限（解析回数/ユーザー数/ストレージ）に達した場合の挙動が仕様通り（停止 or 従量）になる
8. JPYC支払いが請求書に紐付き、支払い成功/失敗/返金が監査ログと共に追跡できる
9. メール/Slack/Discord/アプリ内通知が、依頼・リマインド・結果通知で送信され、通知ログに残る

---

## 11. 未決事項（v3時点の要確認）

* ウォレット署名を必須とする操作範囲（承認のみ/登録のみ/全重要操作）
* 外部承認者を「席数」に含めるか（デフォルト除外案）
* 条件分岐のルール編集UI（v3でGUI提供するか、テンプレ固定か）
* 請求の締め/支払いタイミング（都度/翌月/デポジット）
* 返金ポリシー（全額/日割り/手数料）

---

## 12. リスク・留意点

* リンク承認は便利だが漏洩リスクがあるため、最小権限＋短期限＋失効運用を必須化
* JPYC入金照合は参照ID運用が鍵。Txメモ/送金元固定など運用設計が必要
* 監査ログの“信頼性”は改ざん耐性設計（ハッシュチェーン、アクセス制御）と運用がセット

---

（以上）
