# 要件定義書_v2（完成版）

対象プロダクト：LexFlow（弁護士向け契約・交渉・証跡・決済支援）
追記テーマ：x402（HTTPネイティブ課金）＋ ZK（ゼロ知識証明）
対象機能：F2 / F3 / F4 / F7 + F8（x402） + F9（ZK）

---

## 0. 改訂方針（重要）

### 0.1 目的

* 弁護士のPain（抜け漏れ、合意証跡、交渉の往復、受任前チェック）を、**AIエージェント**で業務化し、**スマートコントラクト＋暗号学的証跡（EIP-712/ハッシュ）**で強固にする。
* 追加で **x402** により「AI処理をAPI単位で従量課金」可能にし、**“AIが価値を出すほど回すほど課金できる”**形を完成させる。x402はHTTP 402と`PAYMENT-REQUIRED`/`PAYMENT-SIGNATURE`ヘッダによる支払い要求・支払い・再試行を基本フローとする。([Coinbase Developer Docs][1])
* 追加で **ZK（ゼロ知識証明）** により、受任前のKYC/適格性チェック等で「**必要十分な事実だけを証明**し、個人情報・秘匿情報を出し過ぎない」形にする（選択的開示・最小開示）。([Galactica][2])

### 0.2 “大きな変更をしない”ための原則

* **契約本文や個人情報はオンチェーンに載せない**（現状方針維持）。オンチェーンはハッシュ・署名・状態・イベント中心。
* AI機能群は現状のLangGraph等を維持し、**APIゲート前段にx402 Paywallを1枚追加**するだけで導入可能にする。([Coinbase Developer Docs][1])
* ZKは全機能に無理に混ぜず、**受任前チェック（F7）を最初の主戦場**にして、価値を体感できる形で導入する（他はStretch）。

---

## 1. 前提・用語

* Case（案件）：契約書や交渉、証跡、決済、義務管理を束ねる単位
* Contract Version（版）：v1, v2, …（docHashで同一性を担保）
* Evidence（証跡）：誰が、いつ、どの版に、何を承認したか
* Obligation（義務）：期限/条件/当事者/行為/根拠条項を持つタスク単位
* x402：HTTP 402を用いる支払いプロトコル。サーバは402と`PAYMENT-REQUIRED`で支払条件提示、クライアントは`PAYMENT-SIGNATURE`等で支払ペイロードを付けて再リクエスト、サーバは検証・決済して200を返す。([Coinbase Developer Docs][1])
* ZK（Zero-Knowledge Proof）：秘密（個人情報等）を明かさずに「ある条件を満たす」事実だけを証明する暗号技術。([Vitalik][3])

---

## 2. 全体アーキテクチャ（追記）

### 2.1 既存（想定）

* Frontend（弁護士・依頼者）
* Backend API（案件管理、ファイル、AI実行、監査ログ）
* AI Agent Service（義務抽出、redline解析、オンボーディング）
* Onchain（証跡/必要に応じ決済）

### 2.2 追記：x402 Paywall（F8）

* API Gateway / Paywall をBackend前段に追加
* 有料対象エンドポイントへの初回アクセスは **402 Payment Required** を返す
* `PAYMENT-REQUIRED` ヘッダで支払要件（価格、通貨、ネットワーク、受取先等）を提示
* クライアントは`PAYMENT-SIGNATURE`等で支払い情報を付与し再実行
* サーバは（任意でfacilitator経由）検証・決済して処理続行 ([Coinbase Developer Docs][1])

### 2.3 追記：ZK Verifier（F9）

* ZK証明の検証を行う **Verifier Service**（Backend内モジュールでも可）
* Verifierは「ZK proofの有効性」「Issuer/ルールに合致するか」を判定し、結果を案件に保存
* オンチェーンに載せる場合は、**proofや個人情報そのものではなく**、結果のハッシュ・イベントのみ（最小開示）

---

## 3. 課金戦略（x402の導入目的を明確化）

### 3.1 課金対象（原則）

* “AIの計算コストが発生する処理”に課金（価値＝回数に比例）
* 具体：

  * F2：義務カレンダー抽出（契約PDF→義務JSON）
  * F4：redline交渉エージェント（差分→意図/リスク/対案/依頼者説明）
  * F7：オンボーディング（質問生成・照合・レポート生成）
  * （任意）F3：依頼者向けの合意要点・リスク要約生成

### 3.2 x402の基本フロー（要件）

* ①通常リクエスト
* ②サーバが402＋`PAYMENT-REQUIRED`で支払条件提示
* ③クライアントが支払ペイロードを構築し`PAYMENT-SIGNATURE`で再送
* ④サーバが検証・決済後、処理結果を200で返す ([Coinbase Developer Docs][1])

### 3.3 決済通貨・ネットワーク（要件）

* “EVM系”を前提に選択可能にする（ネットワーク識別子を支払要件に含める）
* 実務・物語上は **stablecoin** 前提（AI課金は即時少額決済が相性良い）([Coinbase][4])
* 参考：JPYCは複数ネットワークでの発行が示されているため、案件側の決済設計とも整合をとれる（ただし本番は規制・本人確認要件等の検討が必要）。([JPYC][5])

---

## 4. 機能要件（既存F2/F3/F4/F7を“x402＋ZK対応”に拡張）

# F2：義務カレンダー自動生成＋状態同期（x402対応）

## 4.1 目的

* 契約上の期限・義務を構造化し、抜け漏れを防ぐ

## 4.2 入出力

* 入力：契約書PDF（または抽出テキスト）
* 出力：Obligation配列（JSON相当）

  * title / type / due_date（絶対or相対）/ trigger_condition / responsible_party / action / evidence_required / risk_level / confidence / 根拠条項（条番号＋抜粋）

## 4.3 UI要件

* 期限順タイムライン
* party/type/riskフィルタ
* 弁護士が編集可能（編集履歴・監査ログ必須）

## 4.4 状態同期（最小）

* Obligation状態：PENDING / DUE_SOON / COMPLETED / OVERDUE / DISPUTED
* F3の「合意成立」や（任意）決済Tx等をトリガに状態更新

## 4.5 x402課金

* エンドポイント例：`/ai/obligations/extract`
* 初回は402を返し、`PAYMENT-REQUIRED`で価格・通貨・ネットワークを提示 ([Coinbase Developer Docs][1])
* 支払い成立後に抽出を実行して200を返す

## 4.6 受入基準

* 主要義務（支払/更新解除/検収納品/通知）が抽出され、UIで編集できる
* x402経由で「402→支払→再試行→結果」が成立する

---

# F3：オンチェーン承認・合意証跡（強化＋分かりやすさ）

## 4.7 目的

* どの版に、誰が、いつ同意/承認したかを第三者検証可能な形で残す

## 4.8 docHash固定

* 契約書（PDF/テキスト）からdocHashを生成し、versionとcaseIdに紐づける

## 4.9 EIP-712署名（合意の強化）

* 署名対象（Typed Data）に必須：

  * caseId / docHash / version / role / timestamp
* UIで署名前に「要点（AI要約）＋主要リスク」を表示（誤署名防止）

## 4.10 証跡ビュー

* 案件→版→署名者一覧→署名時刻→検証結果（OK/NG）

## 4.11 x402との関係（任意）

* コア署名/ハッシュ固定は無料でも可（採用障壁を下げる）
* ただし「依頼者向け要点・リスク説明生成」をAIで提供する場合はx402課金対象にできる

## 4.12 ZKとの関係（最小/Stretch）

* 最小：ZKはF3に必須ではない（変更を最小化）
* Stretch：依頼者/相手方の適格性（KYC済み等）を“ZKで証明した上で署名”という連携を可能にする（F9参照）

## 4.13 受入基準

* docHash不一致はNGと表示
* 署名が揃うと合意成立ステータスへ遷移し、F2のタイムラインにも反映

---

# F4：Redline支援 交渉エージェント（x402対応）

## 4.14 目的

* 修正往復を短縮し、意図把握・リスク説明・対案作成を自動化

## 4.15 入出力

* 入力：自社ドラフトvN＋相手修正版vN’
* 出力：差分一覧（条項単位）＋各差分の

  * change_summary / likely_intent / risk_assessment / playbook_match / counter_proposal（1〜2案）/ client_explanation（平易）

## 4.16 交渉メモ生成

* 優先順位付き論点
* 相手方へ送るメール文案（短く、角が立たない）

## 4.17 版管理連携

* 次版（vN+1）作成時にdocHash生成し、F3署名へ接続

## 4.18 x402課金

* エンドポイント例：`/ai/redline/analyze`
* 402で支払要件提示→支払い成立後に分析実行 ([Coinbase Developer Docs][1])

## 4.19 受入基準

* 差分が条項単位で出て、依頼者向け説明が自動生成される
* x402の決済フローが成立し、結果が返る

---

# F7：オンボーディング（KYC/利益相反チェック）エージェント化（ZKを主戦場）

## 4.20 目的

* 受任前チェックを標準化しつつ、個人情報の過剰提出を避ける
* “合規性”そのものより、**「弁護士が安心して受任判断できる証拠の形」**を作る

## 4.21 ベース（AIエージェント）

* 入力：依頼者情報（会社名/代表/所在地/担当/相手方/案件概要）
* 出力：

  * チェックリスト（必要資料・確認項目）
  * 不足情報の質問
  * 利益相反候補（案件DB照合）
  * 受任判断レポート（OK/要追加調査/不可＋理由）

## 4.22 x402課金

* エンドポイント例：`/ai/onboarding/check`
* 402で支払要件提示→支払い成立後にチェック実行 ([Coinbase Developer Docs][1])

---

## 5. F9：ZK（ゼロ知識証明）導入要件（“大きく変えずに効く”形）

> ZKは「秘密を出さずに“条件を満たす”事実だけ証明」できる。([Vitalik][3])
> LexFlowではまず **受任前の本人/適格性チェック**で最も価値が出る。

### 5.1 ZKで証明したい“事実”（MVP）

以下のうち少なくとも1つをMVPに採用（複数可）：

* (ZK-1) 「依頼者（または担当者）がKYC済みである」
* (ZK-2) 「依頼者（または担当者）が所定の条件を満たす（例：居住国/年齢/属性など）」※具体属性はハッカソンではダミー可
* (ZK-3) 「依頼者が“所定の信頼できる発行者(Issuer)”から発行された資格/証明（VC等）を保有している」

ZK-KYCは“個人情報を直接渡さずに、KYC通過等の事実を証明できる”というコンセプトが整理されている。([Galactica][2])

### 5.2 証明フォーマット（要件）

* Issuer / Holder / Verifier の三者モデルを前提とする（VCの一般モデル）。([W3C][6])
* 選択的開示（必要情報だけ開示）ができる設計を採用（最小開示）。([W3C][7])
* 検証はLexFlowのZK Verifierで完結（外部に個人情報を拡散しない）

### 5.3 オンボーディング（F7）への組み込み（最小変更）

* 受任前フォームに「ZK Proof（またはVC＋ZK presentation）」アップロード/送信欄を追加
* Verifierが以下を判定し、案件に保存：

  * `zk_status`（VERIFIED / FAILED / NOT_PROVIDED）
  * `issuer_id`
  * `verified_at`
  * `proof_hash`（証明そのもののハッシュ）
* “証明そのもの”はオフチェーン保存、オンチェーンに載せる場合は **hashのみ**（秘匿維持）

### 5.4 F3（合意証跡）との連携（推奨）

* “署名前条件”として、案件ポリシーにより以下を設定可能：

  * 例：client署名を受け付ける前に `zk_status=VERIFIED` が必要
* これにより「**KYC済みの当事者が、特定の版に署名した**」というストーリーが成立し、証跡の説得力が増す

### 5.5 ZKのメリット（プロダクト上の説明に必須）

* 個人情報を“提出し続ける”運用から、「条件を満たす事実だけを証明」へ（データ最小化）。([Vitalik][3])
* 受任前チェックで扱う情報（本人確認等）を必要以上に保管しない＝漏えいリスク低減（説明可能な形）

### 5.6 Stretch（やりたいが重いので任意）

* (ZK-S1) 利益相反チェックの“実行証明”：
  「当事務所の非公開DBと照合した結果、利益相反なし」を、DBを開示せずに証明（zkVM等が必要で難度高）
* (ZK-S2) 契約内容の“性質証明”：
  「このdocHashの契約は、解除通知30日以上/準拠法JP/秘密保持あり」等の性質だけを証明（回路/証明設計が重め）

---

## 6. F8：x402導入要件（完成版）

### 6.1 Paywall対象エンドポイント一覧（MVP）

* `/ai/obligations/extract`（F2）
* `/ai/redline/analyze`（F4）
* `/ai/onboarding/check`（F7）
* （任意）`/ai/approval/summary`（F3補助）

### 6.2 サーバ応答要件

* 無課金で叩いた場合：402＋`PAYMENT-REQUIRED`ヘッダで支払要件提示 ([Coinbase Developer Docs][1])
* 課金済みリクエスト：`PAYMENT-SIGNATURE`等を含む（クライアントが付与）([GitHub][8])
* 検証・決済後：200でAI結果

### 6.3 運用要件（最低限）

* 料金は「固定単価（endpoint別）」をMVPとし、将来は「入力サイズ/難度」で可変に拡張
* 失敗時のUX（必須）：

  * 不足、ネットワーク不一致、署名拒否など原因を明確に表示
* 監査ログ：

  * caseId / endpoint / amount / token / network / payerAddress / timestamp を保存（個人情報は最小）

---

## 7. セキュリティ・プライバシー（x402＋ZK＋証跡を矛盾なく）

* オンチェーン：docHash、署名、状態、イベント（最小）
* オフチェーン：契約本文、ZK proof（必要なら暗号化保存）
* ZKの発行者（Issuer）やVCモデルを前提に、選択的開示/最小開示の方針を明確にする ([W3C][6])

---

## 8. 受入基準（E2E）

### 8.1 x402（必須）

* 402→支払→再試行→200 が、F2/F4/F7のいずれかで一連に動く ([Coinbase Developer Docs][1])

### 8.2 ZK（必須：F7に限定してOK）

* オンボーディングでZK proofを提出すると、Verifierが検証し `zk_status=VERIFIED` を返す
* `proof_hash` が案件に紐づき、（任意）オンチェーンにhashが固定される
* その条件のもとでF3の署名フローに進める（「KYC済み当事者が特定版に署名」）

### 8.3 “弁護士のPain解消”としての体感（必須）

* 1つの案件について、以下が連続デモできる：

  1. 契約PDF投入→（x402課金）義務抽出（F2）
  2. 相手修正投入→（x402課金）redline解析（F4）
  3. 依頼者が（ZKでKYC済みを証明）→署名（F7→F3）
  4. 証跡ビューで「いつ誰がどの版に同意」＋「ZK verified」が見える（F3）

---

## 9. デモ/審査向けの“見せ方”（仕様として固定）

* 画面上に常に以下を表示：

  * docHash（版の確定）
  * 署名者一覧（EIP-712）
  * zk_status（VERIFIED/…）
  * x402の「支払いが発生した」ログ（endpoint/金額/Txまたは検証OK）
* 「AIが仕事をするたびにHTTP 402で支払が走る」ことを可視化（x402の強み）([Coinbase Developer Docs][1])

---

## 10. スコープ外（明確化）

* 本番KYC/反社DBの完全統合（法令対応込み）はスコープ外（ハッカソンでは概念/プロトタイプ）
* ZKによる利益相反“非開示DB照合証明”はStretch（難度高）
* オンチェーンに個人情報や契約本文を載せる設計は採用しない

[1]: https://docs.cdp.coinbase.com/x402/welcome?utm_source=chatgpt.com "Welcome to x402 - Coinbase Developer Documentation"
[2]: https://docs.galactica.com/galactica-developer-documentation/galactica-concepts/zero-knowledge-kyc?utm_source=chatgpt.com "Zero-Knowledge KYC | Galactica Network Dev Documentation"
[3]: https://vitalik.eth.limo/general/2022/06/15/using_snarks.html?utm_source=chatgpt.com "Some ways to use ZK-SNARKs for privacy"
[4]: https://www.coinbase.com/developer-platform/discover/launches/x402?utm_source=chatgpt.com "Introducing x402: a new standard for internet-native ..."
[5]: https://jpyc.jp/?utm_source=chatgpt.com "JPYC | エンをつなげる日本円ステーブルコイン"
[6]: https://www.w3.org/TR/vc-data-model-2.0/?utm_source=chatgpt.com "Verifiable Credentials Data Model v2.0"
[7]: https://www.w3.org/TR/vc-imp-guide/?utm_source=chatgpt.com "Verifiable Credentials Implementation Guidelines 1.0"
[8]: https://github.com/coinbase/x402?utm_source=chatgpt.com "x402: Payments Protocol for the Internet. Built on HTTP."
