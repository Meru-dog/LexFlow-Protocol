# LexFlow Protocol — 要件定義書

**バージョン**: 1.0  
**作成日**: 2025年1月  
**対象**: MVP（Minimum Viable Product）開発

---

## 1. プロジェクト概要

### 1.1 プロジェクト名
**LexFlow Protocol**

### 1.2 目的
契約条件の履行管理と支払処理を、AI判定とブロックチェーン技術により自動化し、企業法務における契約・義務・決済の同期を実現する。

### 1.3 対象ユーザー
- 企業法務担当弁護士（M&A / 資金調達領域）
- ベンチャーキャピタル（VC）
- スタートアップ企業

### 1.4 成功基準
「1つの契約の1条件が自動決済される」システムの稼働

---

## 2. 機能要件

### 2.1 契約書解析機能

#### 2.1.1 PDF契約書アップロード
- **要件**: ユーザーがPDF形式の契約書をアップロードできる
- **入力**: PDF契約書ファイル
- **出力**: アップロード完了通知、ファイルID

#### 2.1.2 AI条項抽出
- **要件**: LangGraphを使用して契約書から条項、義務、支払条件を自動抽出
- **処理内容**:
  - OpenAI APIによるテキスト解析
  - 条項の構造化（JSON形式）
  - 支払条件の識別（金額、条件、期限）
  - マイルストーンの抽出
- **出力**: 構造化された契約データ（スキーマ）

#### 2.1.3 条件スキーマ化
- **要件**: 抽出された条項をスマートコントラクト実行可能な形式に変換
- **スキーマ項目**:
  - 条件ID
  - 条件タイプ（マイルストーン達成、期日到来、承認取得等）
  - 支払金額
  - 支払先アドレス
  - 判定基準

---

### 2.2 履行判定機能

#### 2.2.1 証跡入力インターフェース
- **要件**: ユーザーが履行証跡（エビデンス）を入力できる
- **入力形式**:
  - テキスト入力
  - ファイルアップロード（PDF、画像）
  - 日付情報
- **対象**: 各マイルストーン、条件達成の証明

#### 2.2.2 AI自動判定
- **要件**: 入力された証跡をAIが分析し、条件達成の可否を判定
- **判定プロセス**:
  1. 証跡データの解析
  2. 契約条件との照合
  3. Yes/No判定の出力
  4. 判定理由の生成
- **出力**: 判定結果（承認/却下）、判定理由

#### 2.2.3 弁護士承認フロー
- **要件**: AI判定後、最終承認を弁護士が実施
- **機能**:
  - AI判定結果の確認UI
  - 承認/却下ボタン
  - コメント入力機能
  - 承認履歴の記録

---

### 2.3 決済実行機能

#### 2.3.1 スマートコントラクト連携
- **要件**: 承認された条件に基づきEthereumスマートコントラクトを起動
- **技術仕様**:
  - Solidity言語での実装
  - 条件IDをキーとした実行
  - エスクロー機能
  - 比例送金機能
- **トリガー**: 弁護士による最終承認

#### 2.3.2 JPYC送金
- **要件**: スマートコントラクトからJPYC（日本円ステーブルコイン）を自動送金
- **処理内容**:
  - エスクロー解除
  - 指定アドレスへの送金
  - 送金完了通知
- **出力**: トランザクションハッシュ

#### 2.3.3 取引証跡記録
- **要件**: すべての取引をブロックチェーン上に記録
- **記録内容**:
  - 契約ID
  - 条件ID
  - 判定結果
  - 送金額
  - 送金先
  - タイムスタンプ
  - トランザクションハッシュ

---

### 2.4 管理・閲覧機能

#### 2.4.1 ダッシュボード
- **要件**: 契約一覧と進捗状況を可視化
- **表示項目**:
  - 契約一覧
  - 各契約の進捗率
  - 未達成条件
  - 支払済み金額
  - 保留中の判定

#### 2.4.2 取引履歴閲覧
- **要件**: Etherscanでの取引確認リンク提供
- **機能**:
  - トランザクション詳細へのリンク
  - 取引履歴のフィルタリング
  - CSV出力

---

## 3. 非機能要件

### 3.1 セキュリティ要件
- **認証**: MetaMaskによるウォレット認証
- **権限管理**: 弁護士のみが最終承認可能
- **データ暗号化**: 契約書データの暗号化保存
- **秘密鍵管理**: ユーザー側でのウォレット管理

### 3.2 パフォーマンス要件
- **AI解析時間**: 契約書1件あたり30秒以内
- **トランザクション処理**: Ethereumネットワークの標準速度に準拠
- **同時接続**: MVP段階では10ユーザー程度を想定

### 3.3 可用性要件
- **稼働率**: MVP段階では95%以上を目標
- **バックアップ**: 契約データの日次バックアップ

### 3.4 スケーラビリティ要件
- **将来拡張**: 複数ブロックチェーン対応の設計
- **API設計**: RESTful APIでの外部連携を想定

### 3.5 ユーザビリティ要件
- **UI言語**: 日本語
- **レスポンシブ対応**: デスクトップ優先、タブレット対応
- **操作性**: 法務担当者が直感的に操作可能なUI

---

## 4. 技術スタック

### 4.1 フロントエンド
- **フレームワーク**: React.js / Next.js
- **ウォレット連携**: MetaMask SDK
- **UI**: Material-UI / Tailwind CSS

### 4.2 バックエンド
- **言語**: TypeScript / Node.js
- **フレームワーク**: Express.js
- **AI処理**: LangGraph + OpenAI API
- **データベース**: PostgreSQL（契約データ）、IPFS（契約書ファイル）

### 4.3 ブロックチェーン
- **ネットワーク**: Ethereum（Sepolia Testnet → Mainnet）
- **スマートコントラクト**: Solidity
- **開発環境**: Hardhat
- **決済トークン**: JPYC

### 4.4 インフラ
- **ホスティング**: Vercel（フロント）、AWS / GCP（バックエンド）
- **CI/CD**: GitHub Actions

---

## 5. システムアーキテクチャ

### 5.1 システム構成図

```
┌─────────────┐
│   ユーザー   │
│  (弁護士)   │
└──────┬──────┘
       │
       ↓
┌─────────────────────────────────┐
│      フロントエンド (React)      │
│  - 契約書アップロード            │
│  - 証跡入力                      │
│  - 判定結果確認・承認            │
│  - ダッシュボード                │
└──────┬──────────────────┬───────┘
       │                  │
       ↓                  ↓
┌─────────────┐    ┌──────────────┐
│ バックエンド │    │  MetaMask    │
│  (Node.js)  │    │  (Wallet)    │
│             │    └──────┬───────┘
│ - AI解析    │           │
│ - 判定処理  │           │
│ - API提供   │           │
└──────┬──────┘           │
       │                  │
       ↓                  ↓
┌─────────────┐    ┌──────────────────┐
│  LangGraph  │    │ Ethereum Network │
│  + OpenAI   │    │                  │
│             │    │ - Smart Contract │
│ - 条項抽出  │    │ - JPYC送金       │
│ - 判定AI    │    │ - Tx記録         │
└─────────────┘    └──────────────────┘
       │                  │
       ↓                  ↓
┌─────────────┐    ┌──────────────┐
│ PostgreSQL  │    │  Etherscan   │
│ (契約DB)    │    │  (証跡確認)  │
└─────────────┘    └──────────────┘
```

---

## 6. データモデル

### 6.1 契約データ (Contracts)
```typescript
interface Contract {
  id: string;
  title: string;
  pdfUrl: string;
  uploadedAt: Date;
  parsedData: ParsedContract;
  status: 'pending' | 'active' | 'completed';
  createdBy: string; // ウォレットアドレス
}
```

### 6.2 条件データ (Conditions)
```typescript
interface Condition {
  id: string;
  contractId: string;
  type: 'milestone' | 'deadline' | 'approval';
  description: string;
  paymentAmount: number;
  recipientAddress: string;
  status: 'pending' | 'judging' | 'approved' | 'executed';
  aiJudgment?: Judgment;
  finalApproval?: Approval;
}
```

### 6.3 判定データ (Judgments)
```typescript
interface Judgment {
  id: string;
  conditionId: string;
  evidenceUrl: string;
  aiResult: 'approved' | 'rejected';
  aiReason: string;
  judgedAt: Date;
}
```

### 6.4 承認データ (Approvals)
```typescript
interface Approval {
  id: string;
  judgmentId: string;
  approvedBy: string; // ウォレットアドレス
  result: 'approved' | 'rejected';
  comment?: string;
  approvedAt: Date;
}
```

### 6.5 トランザクションデータ (Transactions)
```typescript
interface Transaction {
  id: string;
  conditionId: string;
  txHash: string;
  amount: number;
  from: string;
  to: string;
  executedAt: Date;
  blockNumber: number;
}
```

---

## 7. ユーザーストーリー

### 7.1 契約書アップロードから決済まで（基本フロー）

**As a** 企業法務担当弁護士  
**I want to** 契約書をアップロードして条件を自動抽出し、履行時に自動決済される仕組みを利用したい  
**So that** 契約管理と支払処理の手間を削減し、トラブルを防止できる

#### シナリオ:
1. 弁護士がPDF契約書をアップロード
2. システムがAIで条項を解析し、支払条件を抽出
3. 抽出結果を弁護士が確認・修正
4. 契約相手がマイルストーン達成の証跡を提出
5. AIが証跡を判定し、結果を提示
6. 弁護士が最終承認
7. スマートコントラクトが自動実行され、JPYCが送金される
8. トランザクションがEtherscan上で確認可能になる

---

## 8. 制約事項

### 8.1 MVP段階での制約
- 対応契約書: 日本語のみ
- 対応ブロックチェーン: Ethereumのみ
- 決済通貨: JPYCのみ
- ST（証券トークン）: 範囲外
- 同時処理: 1契約1条件のシンプルケースのみ

### 8.2 法的制約
- 弁護士法: AI判定は補助行為、最終判断は弁護士が実施
- 資金決済法: JPYCの利用規約に準拠
- 個人情報保護法: 契約書内の個人情報の適切な管理

---

## 9. リスクと対策

| リスク | 影響度 | 対策 |
|--------|--------|------|
| AI判定の精度不足 | 高 | 弁護士による最終承認フローを必須化 |
| ガス代高騰 | 中 | Layer2への移行を将来検討 |
| JPYC流動性不足 | 中 | 他ステーブルコイン対応を検討 |
| 契約書フォーマット多様性 | 高 | 初期は標準フォーマットに限定 |
| セキュリティ侵害 | 高 | 監査、暗号化、権限管理の徹底 |

---

## 10. 開発フェーズ

### Phase 1: MVP開発（1〜2月）
- [ ] 契約書PDF解析機能
- [ ] AI条項抽出（LangGraph + OpenAI）
- [ ] 基本UI（アップロード、確認画面）
- [ ] Solidityスマートコントラクト（エスクロー1条件）
- [ ] MetaMask連携
- [ ] JPYC送金機能
- [ ] Sepolia Testnetでの動作確認

### Phase 2: PoC実証（2〜3月）
- [ ] SAFE/SPA契約での実証実験
- [ ] 証跡入力UI改善
- [ ] AI判定精度向上
- [ ] 弁護士承認フロー実装
- [ ] ダッシュボード機能

### Phase 3: 拡張・改善（4〜6月）
- [ ] 複数条件対応
- [ ] 複数契約管理
- [ ] レポート機能
- [ ] 実案件での試験運用
- [ ] フィードバック収集と改善

---

## 11. 成果物

### 11.1 提出物（審査用）
- GitHub リポジトリ（コード全体）
- デモ動画（契約→判定→送金の一連フロー）
- Etherscan トランザクション証跡
- 技術ドキュメント
- ピッチ資料（Google Slides）

### 11.2 ドキュメント
- 本要件定義書
- システム設計書
- API仕様書
- スマートコントラクト仕様書
- ユーザーマニュアル

---

## 12. 評価指標（KPI）

### 12.1 技術指標
- AI条項抽出精度: 80%以上
- AI判定精度: 85%以上
- トランザクション成功率: 95%以上
- システム稼働率: 95%以上

### 12.2 ビジネス指標
- PoC参加企業数: 3社以上
- 処理契約数: 10件以上
- ユーザー満足度: 4.0/5.0以上

---

**以上**
